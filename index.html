<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ˜éšŠçœ‹æ¿ç³»çµ±</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <style>
    * { font-family: 'Noto Sans TC', sans-serif; }
    .drag-over { background-color: #e0e7ff !important; border: 2px dashed #6366f1 !important; }
    .card-dragging { opacity: 0.5; transform: rotate(3deg); }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app">
    <!-- è¼‰å…¥ä¸­ -->
    <div v-if="loading" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        <p class="text-gray-600">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div v-else-if="error" class="min-h-screen flex items-center justify-center">
      <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-md">
        <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">ç„¡æ³•è¼‰å…¥</h2>
        <p class="text-gray-600 mb-4">{{ error }}</p>
        <button 
          v-if="showRetryLogin"
          @click="signInWithGoogle"
          class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
        >
          é‡æ–°ç™»å…¥
        </button>
      </div>
    </div>

    <!-- Google ç™»å…¥ç•«é¢ -->
    <div v-else-if="!currentUser" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 text-center">
        <div class="text-6xl mb-4">ğŸ“‹</div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">åœ˜éšŠçœ‹æ¿ç³»çµ±</h1>
        <p class="text-gray-500 mb-6">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
        
        <button 
          @click="signInWithGoogle"
          class="w-full py-3 px-4 bg-white border-2 border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center justify-center space-x-3"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span class="text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
        </button>
        
        <p class="mt-6 text-sm text-gray-400">
          é¦–æ¬¡ç™»å…¥éœ€è¦ç®¡ç†å“¡æˆæ¬Š
        </p>
      </div>
    </div>

    <!-- æœªæˆæ¬Šç•«é¢ -->
    <div v-else-if="!isAuthorized" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 text-center">
        <div class="text-6xl mb-4">ğŸ”’</div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">å°šæœªæˆæ¬Š</h1>
        <p class="text-gray-500 mb-2">æ‚¨çš„å¸³è™Ÿå°šæœªè¢«æˆæ¬Šä½¿ç”¨æ­¤ç³»çµ±</p>
        <p class="text-gray-400 text-sm mb-6">{{ currentUser.email }}</p>
        
        <button 
          @click="signOut"
          class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
        >
          ä½¿ç”¨å…¶ä»–å¸³è™Ÿç™»å…¥
        </button>
        
        <p class="mt-6 text-sm text-gray-400">
          è«‹è¯çµ¡ç®¡ç†å“¡å°‡æ‚¨çš„ Email åŠ å…¥æˆæ¬Šåå–®
        </p>
      </div>
    </div>

    <!-- ä¸»ä»‹é¢ -->
    <div v-else class="min-h-screen flex flex-col">
      <!-- é ‚éƒ¨å°èˆª -->
      <header class="bg-white shadow-sm border-b border-gray-200 px-4 py-3">
        <div class="flex items-center justify-between">
          <!-- å·¦å´ï¼šæ¨™é¡Œå’Œçœ‹æ¿é¸æ“‡ -->
          <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-gray-800 whitespace-nowrap">ğŸ“‹ åœ˜éšŠçœ‹æ¿</h1>
            
            <!-- çœ‹æ¿é¸æ“‡ -->
            <div class="flex items-center space-x-2">
              <select 
                v-model="currentBoardId"
                class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none min-w-32"
              >
                <option value="">é¸æ“‡çœ‹æ¿</option>
                <option v-for="board in boards" :key="board.id" :value="board.id">
                  {{ board.name }}
                </option>
              </select>
              
              <button 
                v-if="role === 'admin'"
                @click="showNewBoardModal = true"
                class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors whitespace-nowrap"
              >
                + æ–°å¢
              </button>
            </div>
          </div>
          
          <!-- ä¸­é–“ï¼šè¦–åœ–åˆ‡æ› -->
          <div class="flex bg-gray-100 rounded-lg p-1">
            <button 
              @click="currentView = 'board'"
              :class="currentView === 'board' ? 'bg-white shadow-sm' : ''"
              class="px-3 py-1 text-sm rounded-md transition-all"
            >
              ğŸ“‹ çœ‹æ¿
            </button>
            <button 
              @click="currentView = 'calendar'"
              :class="currentView === 'calendar' ? 'bg-white shadow-sm' : ''"
              class="px-3 py-1 text-sm rounded-md transition-all"
            >
              ğŸ“… æ—¥æ›†
            </button>
            <button 
              @click="currentView = 'gantt'"
              :class="currentView === 'gantt' ? 'bg-white shadow-sm' : ''"
              class="px-3 py-1 text-sm rounded-md transition-all"
            >
              ğŸ“Š ç”˜ç‰¹åœ–
            </button>
          </div>
          
          <!-- å³å´ï¼šå·¥å…·å’Œä½¿ç”¨è€… -->
          <div class="flex items-center space-x-3">
            <!-- å·¥å…·ä¸‹æ‹‰é¸å–® -->
            <div class="relative" ref="toolMenuRef">
              <button 
                @click="showToolMenu = !showToolMenu"
                class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-1"
              >
                <span>âš™ï¸ å·¥å…·</span>
                <span class="text-xs">â–¼</span>
              </button>
              
              <!-- ä¸‹æ‹‰é¸å–®å…§å®¹ -->
              <div 
                v-if="showToolMenu"
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50"
              >
                <button 
                  @click="exportBackup; showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2"
                >
                  <span>ğŸ“¥</span><span>åŒ¯å‡ºå‚™ä»½</span>
                </button>
                <button 
                  v-if="role === 'admin'"
                  @click="openImportModal(); showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2"
                >
                  <span>ğŸ“‚</span><span>åŒ¯å…¥å‚™ä»½</span>
                </button>
                <div v-if="role === 'admin'" class="border-t border-gray-100 my-1"></div>
                <button 
                  v-if="role === 'admin'"
                  @click="showUserManagement = true; showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2"
                >
                  <span>ğŸ‘¥</span><span>ä½¿ç”¨è€…ç®¡ç†</span>
                </button>
                <button 
                  v-if="role === 'admin' && currentBoardId"
                  @click="deleteBoard(); showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2"
                >
                  <span>ğŸ—‘ï¸</span><span>åˆªé™¤çœ‹æ¿</span>
                </button>
              </div>
            </div>
            
            <!-- ä½¿ç”¨è€…è³‡è¨Š -->
            <div class="flex items-center space-x-2 pl-3 border-l border-gray-200">
              <img :src="currentUser.photoURL" class="w-8 h-8 rounded-full" v-if="currentUser.photoURL">
              <div class="hidden sm:block">
                <div class="text-sm font-medium text-gray-700">{{ currentUser.displayName || currentUser.email }}</div>
                <div class="text-xs text-gray-500">{{ role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡' }}</div>
              </div>
              <button 
                @click="signOut"
                class="px-2 py-1 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded"
              >
                ç™»å‡º
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- ä¸»è¦å…§å®¹å€ -->
      <main class="flex-1 overflow-hidden">
        <!-- çœ‹æ¿è¦–åœ– -->
        <div v-if="currentView === 'board'" class="h-full p-4 overflow-x-auto">
          <div class="flex space-x-4 h-full">
            <div 
              v-for="column in sortedColumns" 
              :key="column.id"
              class="flex-shrink-0 w-80 bg-gray-100 rounded-xl flex flex-col max-h-full"
              @dragover.prevent="onCardDragOver($event, column)"
              @drop="onCardDrop($event, column)"
            >
              <div class="p-3 font-medium flex items-center justify-between" :style="{ borderTop: '3px solid ' + (column.color || '#6366f1') }">
                <div class="flex items-center">
                  <span>{{ column.name }}</span>
                  <span class="ml-2 text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">
                    {{ cards.filter(c => c.columnId === column.id).length }}
                  </span>
                </div>
                <div class="flex items-center space-x-1">
                  <button 
                    @click="openNewCardModal(column)"
                    class="p-1 hover:bg-gray-200 rounded transition-colors"
                  >
                    â•
                  </button>
                  <button 
                    v-if="role === 'admin'"
                    @click="openColumnMenu(column)"
                    class="p-1 hover:bg-gray-200 rounded transition-colors"
                  >
                    âš™ï¸
                  </button>
                </div>
              </div>
              
              <div class="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">
                <div
                  v-for="card in cards.filter(c => c.columnId === column.id).sort((a, b) => a.orderIndex - b.orderIndex)"
                  :key="card.id"
                  draggable="true"
                  @dragstart="onCardDragStart($event, card)"
                  @dragend="onCardDragEnd"
                  @click="openCardDetail(card)"
                  class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer transition-shadow border border-gray-200"
                  :class="{ 'card-dragging': draggingCard?.id === card.id }"
                >
                  <div v-if="card.labels && card.labels.length > 0" class="flex flex-wrap gap-1 mb-2">
                    <span 
                      v-for="label in card.labels" 
                      :key="label"
                      class="px-2 py-0.5 text-xs rounded-full text-white"
                      :class="{
                        'bg-red-500': label === 'urgent',
                        'bg-yellow-500': label === 'important',
                        'bg-green-500': label === 'normal',
                        'bg-blue-500': label === 'feature',
                        'bg-purple-500': label === 'bug'
                      }"
                    >
                      {{ labelNames[label] || label }}
                    </span>
                  </div>
                  
                  <h4 class="font-medium text-gray-800 line-clamp-2">{{ card.title }}</h4>
                  <p v-if="card.description" class="text-sm text-gray-500 mt-1 line-clamp-2">{{ card.description }}</p>
                  
                  <div class="flex items-center justify-between mt-2 text-xs text-gray-400">
                    <div class="flex items-center space-x-2">
                      <span v-if="card.dueDate" :class="getDueDateClass(card.dueDate)">
                        ğŸ“… {{ formatDate(card.dueDate) }}
                      </span>
                      <span v-if="card.checklist && card.checklist.length > 0">
                        âœ… {{ card.checklist.filter(i => i.done).length }}/{{ card.checklist.length }}
                      </span>
                    </div>
                    <span v-if="card.assignee" class="text-gray-500">
                      ğŸ‘¤ {{ card.assignee }}
                    </span>
                  </div>
                </div>
                
                <div 
                  v-if="cards.filter(c => c.columnId === column.id).length === 0"
                  class="text-center text-gray-400 text-sm py-8"
                >
                  æ‹–æ‹‰å¡ç‰‡åˆ°é€™è£¡
                </div>
              </div>
            </div>
            
            <div v-if="role === 'admin'" class="flex-shrink-0 w-80">
              <button 
                @click="showNewColumnModal = true"
                class="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-indigo-500 hover:text-indigo-500 transition-colors"
              >
                + æ–°å¢æ¬„ä½
              </button>
            </div>
          </div>
        </div>

        <!-- æ—¥æ›†è¦–åœ– -->
        <div v-if="currentView === 'calendar'" class="h-full p-4 overflow-auto">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <div class="flex items-center justify-end mb-4">
              <label class="flex items-center cursor-pointer">
                <input 
                  type="checkbox" 
                  v-model="showAllBoards"
                  class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 mr-2"
                >
                <span class="text-sm text-gray-600">é¡¯ç¤ºå…¨éƒ¨çœ‹æ¿çš„å¡ç‰‡</span>
              </label>
            </div>
            
            <div class="flex items-center justify-between mb-4">
              <button @click="prevMonth" class="px-3 py-1 hover:bg-gray-100 rounded-lg">â—€</button>
              <h3 class="text-lg font-medium">{{ calendarTitle }}</h3>
              <button @click="nextMonth" class="px-3 py-1 hover:bg-gray-100 rounded-lg">â–¶</button>
            </div>
            
            <div class="grid grid-cols-7 gap-1 mb-2">
              <div v-for="day in ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']" :key="day" class="text-center text-sm font-medium text-gray-500 py-2">
                {{ day }}
              </div>
            </div>
            
            <div class="grid grid-cols-7 gap-1">
              <div 
                v-for="day in calendarDays" 
                :key="day.date"
                class="min-h-24 border border-gray-100 rounded-lg p-1"
                :class="{ 'bg-gray-50': !day.isCurrentMonth, 'bg-blue-50': day.isToday }"
                @dragover.prevent
                @drop="onCalendarDrop($event, day.date)"
              >
                <div class="text-xs text-gray-500 mb-1">{{ day.dayNum }}</div>
                <div class="space-y-1">
                  <div 
                    v-for="card in day.cards" 
                    :key="card.id"
                    draggable="true"
                    @dragstart="onCardDragStart($event, card)"
                    @click="openCardDetail(card)"
                    class="text-xs p-1 bg-indigo-100 text-indigo-700 rounded truncate cursor-pointer hover:bg-indigo-200"
                  >
                    {{ card.title }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç”˜ç‰¹åœ–è¦–åœ– -->
        <div v-if="currentView === 'gantt'" class="h-full p-4 overflow-auto">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <h3 class="text-lg font-medium mb-4">ğŸ“Š ç”˜ç‰¹åœ–</h3>
            
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-4">
                <select v-model="ganttFilterAssignee" class="px-3 py-1.5 border rounded-lg text-sm">
                  <option value="">æ‰€æœ‰æˆå“¡</option>
                  <option v-for="assignee in allAssignees" :key="assignee" :value="assignee">{{ assignee }}</option>
                </select>
              </div>
              <label class="flex items-center cursor-pointer">
                <input 
                  type="checkbox" 
                  v-model="showAllBoards"
                  class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 mr-2"
                >
                <span class="text-sm text-gray-600">é¡¯ç¤ºå…¨éƒ¨çœ‹æ¿çš„å¡ç‰‡</span>
              </label>
            </div>
            
            <div class="overflow-x-auto">
              <div class="min-w-max">
                <div class="flex border-b">
                  <div class="w-48 flex-shrink-0 p-2 font-medium text-sm text-gray-600">ä»»å‹™</div>
                  <div class="flex">
                    <div 
                      v-for="date in ganttDates" 
                      :key="date"
                      class="w-8 p-1 text-center text-xs text-gray-500 border-l"
                      :class="{ 'bg-blue-50': isToday(date) }"
                    >
                      {{ new Date(date).getDate() }}
                    </div>
                  </div>
                </div>
                
                <div 
                  v-for="card in filteredGanttCards" 
                  :key="card.id"
                  class="flex border-b hover:bg-gray-50"
                >
                  <div class="w-48 flex-shrink-0 p-2 text-sm truncate cursor-pointer hover:text-indigo-600" @click="openCardDetail(card)">
                    {{ card.title }}
                  </div>
                  <div class="flex relative">
                    <div 
                      v-for="date in ganttDates" 
                      :key="date"
                      class="w-8 h-8 border-l"
                      :class="{ 'bg-blue-50': isToday(date) }"
                    ></div>
                    <div 
                      v-if="card.startDate && card.dueDate"
                      class="absolute h-6 top-1 bg-indigo-400 rounded"
                      :style="getGanttBarStyle(card)"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- æ–°å¢çœ‹æ¿å½ˆçª— -->
    <div v-if="showNewBoardModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢çœ‹æ¿</h3>
        <input 
          v-model="newBoardName"
          type="text"
          placeholder="çœ‹æ¿åç¨±"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
          @keyup.enter="createBoard"
        >
        <div class="flex justify-end space-x-2">
          <button @click="showNewBoardModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="createBoard" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢æ¬„ä½å½ˆçª— -->
    <div v-if="showNewColumnModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢æ¬„ä½</h3>
        <input 
          v-model="newColumnName"
          type="text"
          placeholder="æ¬„ä½åç¨±"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
        >
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex space-x-2">
            <button 
              v-for="color in columnColors" 
              :key="color"
              @click="newColumnColor = color"
              class="w-8 h-8 rounded-full border-2"
              :class="newColumnColor === color ? 'border-gray-800' : 'border-transparent'"
              :style="{ backgroundColor: color }"
            ></button>
          </div>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="showNewColumnModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="createColumn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢å¡ç‰‡å½ˆçª— -->
    <div v-if="showNewCardModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢å¡ç‰‡</h3>
        <input 
          v-model="newCardTitle"
          type="text"
          placeholder="å¡ç‰‡æ¨™é¡Œ"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
          @keyup.enter="createCard"
        >
        <div class="flex justify-end space-x-2">
          <button @click="showNewCardModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="createCard" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ¬„ä½è¨­å®šé¸å–® -->
    <div v-if="showColumnMenu" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ¬„ä½è¨­å®šï¼š{{ selectedColumn?.name }}</h3>
        <div class="space-y-2">
          <button @click="openEditColumnModal" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg">âœï¸ ç·¨è¼¯æ¬„ä½</button>
          <button @click="confirmArchiveColumn" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 rounded-lg">ğŸ—‘ï¸ åˆªé™¤æ¬„ä½</button>
        </div>
        <button @click="showColumnMenu = false" class="mt-4 w-full py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- ç·¨è¼¯æ¬„ä½å½ˆçª— -->
    <div v-if="showEditColumnModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ç·¨è¼¯æ¬„ä½</h3>
        <input 
          v-model="editingColumn.name"
          type="text"
          placeholder="æ¬„ä½åç¨±"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
        >
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex space-x-2">
            <button 
              v-for="color in columnColors" 
              :key="color"
              @click="editingColumn.color = color"
              class="w-8 h-8 rounded-full border-2"
              :class="editingColumn.color === color ? 'border-gray-800' : 'border-transparent'"
              :style="{ backgroundColor: color }"
            ></button>
          </div>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="showEditColumnModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="saveColumn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- åˆªé™¤æ¬„ä½ç¢ºèª -->
    <div v-if="showArchiveConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤</h3>
        <p class="text-gray-600 mb-4">ç¢ºå®šè¦åˆªé™¤ã€Œ{{ archivingColumn?.name }}ã€æ¬„ä½å—ï¼Ÿæ¬„ä½å…§çš„æ‰€æœ‰å¡ç‰‡ä¹Ÿæœƒè¢«åˆªé™¤ã€‚</p>
        <div class="flex justify-end space-x-2">
          <button @click="showArchiveConfirm = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="archiveColumn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">åˆªé™¤</button>
        </div>
      </div>
    </div>

    <!-- åŒ¯å…¥å‚™ä»½å½ˆçª— -->
    <div v-if="showImportModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <div class="p-4 border-b bg-gray-50">
          <h3 class="text-lg font-bold text-gray-800">ğŸ“‚ åŒ¯å…¥å‚™ä»½</h3>
        </div>
        <div class="p-4">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å‚™ä»½æª”æ¡ˆ</label>
            <input 
              ref="importFileInput"
              type="file" 
              accept=".json"
              @change="handleImportFile"
              class="w-full px-3 py-2 border rounded-lg text-sm"
            >
          </div>
          <div v-if="importPreview" class="mb-4 p-3 bg-blue-50 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-2">ğŸ“‹ å‚™ä»½å…§å®¹é è¦½</h4>
            <div class="text-sm text-gray-600 space-y-1">
              <p>å‚™ä»½æ™‚é–“ï¼š{{ importPreview.exportDate ? new Date(importPreview.exportDate).toLocaleString('zh-TW') : 'æœªçŸ¥' }}</p>
              <p>çœ‹æ¿æ•¸é‡ï¼š{{ importPreview.boardCount }} å€‹</p>
              <p>æ¬„ä½æ•¸é‡ï¼š{{ importPreview.columnCount }} å€‹</p>
              <p>å¡ç‰‡æ•¸é‡ï¼š{{ importPreview.cardCount }} å¼µ</p>
            </div>
          </div>
          <div v-if="importPreview" class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å…¥æ¨¡å¼</label>
            <div class="space-y-2">
              <label class="flex items-start p-3 border rounded-lg cursor-pointer hover:bg-gray-50" :class="{ 'border-blue-500 bg-blue-50': importMode === 'merge' }">
                <input type="radio" v-model="importMode" value="merge" class="mt-1 mr-3">
                <div>
                  <div class="font-medium text-gray-800">åˆä½µåŒ¯å…¥ï¼ˆæ¨è–¦ï¼‰</div>
                  <div class="text-sm text-gray-500">ä¿ç•™ç¾æœ‰è³‡æ–™ï¼Œå‚™ä»½è³‡æ–™æœƒæ–°å¢é€²ä¾†ï¼Œçœ‹æ¿åç¨±åŠ ä¸Šã€Œ(åŒ¯å…¥)ã€</div>
                </div>
              </label>
              <label class="flex items-start p-3 border rounded-lg cursor-pointer hover:bg-gray-50" :class="{ 'border-red-500 bg-red-50': importMode === 'replace' }">
                <input type="radio" v-model="importMode" value="replace" class="mt-1 mr-3">
                <div>
                  <div class="font-medium text-gray-800">è¦†è“‹åŒ¯å…¥</div>
                  <div class="text-sm text-red-500">âš ï¸ æœƒæ¸…é™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼</div>
                </div>
              </label>
            </div>
          </div>
        </div>
        <div class="p-4 border-t bg-gray-50 flex justify-end space-x-2">
          <button @click="closeImportModal" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">å–æ¶ˆ</button>
          <button v-if="importPreview" @click="executeImport" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ç¢ºèªåŒ¯å…¥</button>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨è€…ç®¡ç†å½ˆçª— -->
    <div v-if="showUserManagement" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-800">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</h3>
          <button @click="showUserManagement = false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
          <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-3">æ–°å¢æˆæ¬Šä½¿ç”¨è€…</h4>
            <div class="flex space-x-2">
              <input 
                v-model="newUserEmail"
                type="email"
                placeholder="è¼¸å…¥ Emailï¼ˆä¾‹å¦‚ï¼šuser@gmail.comï¼‰"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                @keyup.enter="addUser"
              >
              <select v-model="newUserRole" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="member">æˆå“¡</option>
                <option value="admin">ç®¡ç†å“¡</option>
              </select>
              <button 
                @click="addUser"
                class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm"
              >
                æ–°å¢
              </button>
            </div>
            <p class="mt-2 text-xs text-gray-500">
              ğŸ’¡ æ–°å¢å¾Œï¼Œè©²ä½¿ç”¨è€…ç”¨ Google ç™»å…¥å³å¯é€²å…¥ç³»çµ±
            </p>
          </div>
          
          <div>
            <h4 class="font-medium text-gray-700 mb-3">å·²æˆæ¬Šä½¿ç”¨è€…ï¼ˆ{{ authorizedUsers.length }} äººï¼‰</h4>
            <div class="space-y-2">
              <div 
                v-for="user in authorizedUsers" 
                :key="user.id"
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
              >
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-medium">
                    {{ user.email.charAt(0).toUpperCase() }}
                  </div>
                  <div>
                    <div class="font-medium text-gray-800">{{ user.email }}</div>
                    <div class="text-xs text-gray-500">
                      {{ user.lastLogin ? 'ä¸Šæ¬¡ç™»å…¥ï¼š' + formatDateTime(user.lastLogin) : 'å°šæœªç™»å…¥' }}
                    </div>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <select 
                    :value="user.role"
                    @change="updateUserRole(user, $event.target.value)"
                    class="px-2 py-1 border border-gray-300 rounded text-sm"
                    :disabled="user.email === currentUser.email"
                  >
                    <option value="member">æˆå“¡</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                  </select>
                  <button 
                    v-if="user.email !== currentUser.email"
                    @click="removeUser(user)"
                    class="p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded"
                  >
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
              
              <div v-if="authorizedUsers.length === 0" class="text-center text-gray-500 py-8">
                å°šç„¡æˆæ¬Šä½¿ç”¨è€…
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-4 border-t bg-gray-50">
          <button 
            @click="showUserManagement = false"
            class="w-full py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
          >
            é—œé–‰
          </button>
        </div>
      </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div v-if="toast.show" class="fixed bottom-4 right-4 z-50">
      <div 
        class="px-4 py-3 rounded-lg shadow-lg text-white"
        :class="{
          'bg-green-500': toast.type === 'success',
          'bg-red-500': toast.type === 'error',
          'bg-blue-500': toast.type === 'info'
        }"
      >
        {{ toast.message }}
      </div>
    </div>

    <!-- å¡ç‰‡è©³æƒ…å½ˆçª— -->
    <div v-if="showCardDetail" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
          <input 
            v-model="editingCard.title"
            type="text"
            class="text-xl font-bold text-gray-800 bg-transparent border-none outline-none flex-1 mr-4"
            placeholder="å¡ç‰‡æ¨™é¡Œ"
          >
          <button @click="closeCardDetail" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <div class="flex-1 overflow-y-auto">
          <div class="flex flex-col md:flex-row">
            <div class="flex-1 p-4 space-y-4">
              <div>
                <h4 class="font-medium text-gray-700 mb-2">ğŸ“ æè¿°</h4>
                <textarea 
                  v-model="editingCard.description"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none"
                  placeholder="æ–°å¢æè¿°..."
                ></textarea>
              </div>
              
              <div class="mb-6">
                <h4 class="font-medium text-gray-700 mb-2 flex items-center">
                  <span class="mr-2">ğŸ“·</span>åœ–ç‰‡
                </h4>
                <div v-if="editingCard.images && editingCard.images.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                  <div v-for="(img, index) in editingCard.images" :key="index" class="relative group">
                    <img :src="img" class="w-full h-24 object-cover rounded-lg">
                    <button 
                      @click="removeImage(index)"
                      class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                    >âœ•</button>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <label class="cursor-pointer px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm text-gray-600 transition-colors">
                    <span>+ ä¸Šå‚³åœ–ç‰‡</span>
                    <input type="file" accept="image/*" @change="uploadImage" class="hidden" :disabled="uploading">
                  </label>
                  <span v-if="uploading" class="text-sm text-gray-500">ä¸Šå‚³ä¸­...</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">âš ï¸ éœ€è¦ Firebase Storageï¼ˆç›®å‰ Spark æ–¹æ¡ˆä¸æ”¯æ´ï¼‰</p>
              </div>
              
              <div class="mb-6">
                <h4 class="font-medium text-gray-700 mb-2 flex items-center">
                  <span class="mr-2">ğŸ“</span>æª”æ¡ˆ
                </h4>
                <div v-if="editingCard.files && editingCard.files.length > 0" class="space-y-2 mb-3">
                  <div v-for="(file, index) in editingCard.files" :key="index" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg group">
                    <a :href="file.url" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1 mr-2">
                      ğŸ“„ {{ file.name }}
                    </a>
                    <button @click="removeFile(index)" class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <label class="cursor-pointer px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm text-gray-600 transition-colors">
                    <span>+ ä¸Šå‚³æª”æ¡ˆ</span>
                    <input type="file" @change="uploadFile" class="hidden" :disabled="uploading">
                  </label>
                </div>
                <p class="text-xs text-gray-400 mt-1">âš ï¸ éœ€è¦ Firebase Storageï¼ˆç›®å‰ Spark æ–¹æ¡ˆä¸æ”¯æ´ï¼‰</p>
              </div>
              
              <div class="mb-6">
                <h4 class="font-medium text-gray-700 mb-2 flex items-center">
                  <span class="mr-2">ğŸ”—</span>å¤–éƒ¨é€£çµï¼ˆGoogle Drive ç­‰ï¼‰
                </h4>
                <div v-if="editingCard.externalLinks && editingCard.externalLinks.length > 0" class="space-y-2 mb-3">
                  <div 
                    v-for="(link, index) in editingCard.externalLinks" 
                    :key="index"
                    class="flex items-center justify-between p-2 bg-gray-50 rounded-lg group"
                  >
                    <a 
                      :href="link.url" 
                      target="_blank" 
                      class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1 mr-2"
                    >
                      ğŸ“„ {{ link.name || link.url }}
                    </a>
                    <button 
                      @click="removeExternalLink(index)"
                      class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"
                    >âœ•</button>
                  </div>
                </div>
                <div v-if="showAddExternalLink" class="p-3 bg-blue-50 rounded-lg mb-2">
                  <input 
                    v-model="newExternalLink.name"
                    type="text" 
                    placeholder="é€£çµåç¨±ï¼ˆä¾‹å¦‚ï¼šæœƒè­°è¨˜éŒ„.pdfï¼‰"
                    class="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                  >
                  <input 
                    v-model="newExternalLink.url"
                    type="url" 
                    placeholder="è²¼ä¸Šé€£çµï¼ˆGoogle Driveã€Dropbox ç­‰ï¼‰"
                    class="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                  >
                  <div class="flex space-x-2">
                    <button 
                      @click="addExternalLink"
                      class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600"
                    >ç¢ºèªæ–°å¢</button>
                    <button 
                      @click="showAddExternalLink = false"
                      class="px-3 py-1.5 bg-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-400"
                    >å–æ¶ˆ</button>
                  </div>
                </div>
                <button 
                  v-if="!showAddExternalLink"
                  @click="showAddExternalLink = true"
                  class="text-sm text-blue-600 hover:text-blue-800"
                >+ æ–°å¢å¤–éƒ¨é€£çµ</button>
                <div class="mt-2 text-xs text-gray-500">
                  ğŸ’¡ æç¤ºï¼šå°‡æª”æ¡ˆä¸Šå‚³åˆ° Google Driveï¼Œå³éµã€Œå…±ç”¨ã€â†’ã€ŒçŸ¥é“é€£çµçš„äººéƒ½å¯ä»¥æŸ¥çœ‹ã€â†’ è¤‡è£½é€£çµè²¼ä¸Š
                </div>
              </div>
              
              <div>
                <h4 class="font-medium text-gray-700 mb-2">âœ… æª¢æŸ¥æ¸…å–®</h4>
                <div class="space-y-2">
                  <div 
                    v-for="(item, index) in editingCard.checklist" 
                    :key="index"
                    class="flex items-center space-x-2"
                  >
                    <input 
                      type="checkbox" 
                      v-model="item.done"
                      class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                    >
                    <input 
                      v-model="item.text"
                      type="text"
                      class="flex-1 px-2 py-1 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none"
                      :class="{ 'line-through text-gray-400': item.done }"
                    >
                    <button @click="editingCard.checklist.splice(index, 1)" class="text-red-500 hover:text-red-700">âœ•</button>
                  </div>
                </div>
                <button 
                  @click="editingCard.checklist = editingCard.checklist || []; editingCard.checklist.push({ text: '', done: false })"
                  class="mt-2 text-sm text-indigo-600 hover:text-indigo-800"
                >
                  + æ–°å¢é …ç›®
                </button>
              </div>
              
              <div>
                <h4 class="font-medium text-gray-700 mb-2">ğŸ’¬ ç•™è¨€</h4>
                <div class="flex space-x-2 mb-4">
                  <input 
                    v-model="newComment"
                    type="text"
                    placeholder="è¼¸å…¥ç•™è¨€..."
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    @keyup.enter="addComment"
                  >
                  <button 
                    @click="addComment"
                    class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                  >
                    é€å‡º
                  </button>
                </div>
                <div class="space-y-3">
                  <div 
                    v-for="comment in cardComments" 
                    :key="comment.id"
                    class="bg-gray-50 rounded-lg p-3"
                  >
                    <div class="flex items-center justify-between mb-1">
                      <span class="font-medium text-sm text-gray-800">{{ comment.author }}</span>
                      <span class="text-xs text-gray-500">{{ formatDateTime(comment.createdAt) }}</span>
                    </div>
                    <p class="text-gray-600 text-sm">{{ comment.content }}</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="w-full md:w-64 p-4 bg-gray-50 border-t md:border-t-0 md:border-l space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                <select 
                  v-model="editingCard.columnId"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                >
                  <option v-for="column in columns" :key="column.id" :value="column.id">
                    {{ column.name }}
                  </option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">æŒ‡æ´¾äºº</label>
                <input 
                  v-model="editingCard.assignee"
                  type="text"
                  placeholder="è¼¸å…¥åå­—"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                <input 
                  v-model="editingCard.startDate"
                  type="date"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥</label>
                <input 
                  v-model="editingCard.dueDate"
                  type="date"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™ç±¤</label>
                <div class="flex flex-wrap gap-2">
                  <button 
                    v-for="(name, key) in labelNames" 
                    :key="key"
                    @click="toggleLabel(key)"
                    class="px-2 py-1 text-xs rounded-full transition-colors"
                    :class="editingCard.labels?.includes(key) 
                      ? 'text-white ' + getLabelBgClass(key)
                      : 'bg-gray-200 text-gray-600 hover:bg-gray-300'"
                  >
                    {{ name }}
                  </button>
                </div>
              </div>
              
              <div class="pt-4 border-t space-y-2">
                <button 
                  @click="saveCard"
                  class="w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors"
                >
                  ğŸ’¾ å„²å­˜è®Šæ›´
                </button>
                <button 
                  @click="deleteCard"
                  class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                >
                  ğŸ—‘ï¸ åˆªé™¤å¡ç‰‡
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyD-j2mxePfU6qj4qMXR_-u-VXuzpv-zEkg",
      authDomain: "team-kanban-f58ae.firebaseapp.com",
      projectId: "team-kanban-f58ae",
      storageBucket: "team-kanban-f58ae.firebasestorage.app",
      messagingSenderId: "15717920457",
      appId: "1:15717920457:web:42b4491eea9486f9e42718"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    createApp({
      setup() {
        // === ç‹€æ…‹è®Šæ•¸ ===
        const loading = ref(true);
        const error = ref('');
        const showRetryLogin = ref(false);
        
        // Google ç™»å…¥ç›¸é—œ
        const currentUser = ref(null);
        const isAuthorized = ref(false);
        const role = ref('');
        const authorizedUsers = ref([]);
        
        // ä½¿ç”¨è€…ç®¡ç†
        const showUserManagement = ref(false);
        const newUserEmail = ref('');
        const newUserRole = ref('member');
        
        // çœ‹æ¿è³‡æ–™
        const boards = ref([]);
        const columns = ref([]);
        const cards = ref([]);
        const cardComments = ref([]);
        const currentBoardId = ref('');
        const currentView = ref('board');
        
        // å½ˆçª—ç‹€æ…‹
        const showNewBoardModal = ref(false);
        const showNewColumnModal = ref(false);
        const showNewCardModal = ref(false);
        const showCardDetail = ref(false);
        const showColumnMenu = ref(false);
        const showEditColumnModal = ref(false);
        const showArchiveConfirm = ref(false);
        const showImportModal = ref(false);
        
        // ç·¨è¼¯ç‹€æ…‹
        const editingCard = ref({});
        const editingColumn = ref({});
        const selectedColumn = ref(null);
        const archivingColumn = ref(null);
        const selectedColumnForNewCard = ref(null);
        
        // è¼¸å…¥ç‹€æ…‹
        const newBoardName = ref('');
        const newColumnName = ref('');
        const newColumnColor = ref('#6366f1');
        const newCardTitle = ref('');
        const newComment = ref('');
        
        // ä¸Šå‚³ç‹€æ…‹
        const uploading = ref(false);
        
        // å¤–éƒ¨é€£çµç‹€æ…‹
        const showAddExternalLink = ref(false);
        const newExternalLink = ref({ name: '', url: '' });
        
        // åŒ¯å…¥ç‹€æ…‹
        const importMode = ref('merge');
        const importFileInput = ref(null);
        const importPreview = ref(null);
        
        // æ‹–æ‹‰ç‹€æ…‹
        const draggingCard = ref(null);
        
        // æ—¥æ›†ç‹€æ…‹
        const calendarDate = ref(new Date());
        
        // ç”˜ç‰¹åœ–ç‹€æ…‹
        const ganttFilterAssignee = ref('');
        
        // é¡¯ç¤ºå…¨éƒ¨çœ‹æ¿é–‹é—œ
        const showAllBoards = ref(false);
        
        // å…¨éƒ¨çœ‹æ¿çš„å¡ç‰‡
        const allBoardsCards = ref([]);

        // å·¥å…·é¸å–®
        const showToolMenu = ref(false);
        
        // Toast
        const toast = ref({ show: false, message: '', type: 'info' });
        
        // å¸¸æ•¸
        const columnColors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444', '#06b6d4'];
        const labelNames = {
          urgent: 'ç·Šæ€¥',
          important: 'é‡è¦',
          normal: 'ä¸€èˆ¬',
          feature: 'åŠŸèƒ½',
          bug: 'éŒ¯èª¤'
        };
        
        // ç›£è½å™¨
        let unsubscribeBoards = null;
        let unsubscribeColumns = null;
        let unsubscribeCards = null;
        let unsubscribeAllCards = null;
        let unsubscribeUsers = null;

        // === è¨ˆç®—å±¬æ€§ ===
        const sortedColumns = computed(() => {
          return [...columns.value].sort((a, b) => a.orderIndex - b.orderIndex);
        });
        
        const displayCards = computed(() => {
          if (showAllBoards.value) {
            return allBoardsCards.value;
          }
          return cards.value;
        });
        
        const calendarTitle = computed(() => {
          const year = calendarDate.value.getFullYear();
          const month = calendarDate.value.getMonth() + 1;
          return `${year} å¹´ ${month} æœˆ`;
        });
        
        const calendarDays = computed(() => {
          const year = calendarDate.value.getFullYear();
          const month = calendarDate.value.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const days = [];
          
          for (let i = 0; i < firstDay.getDay(); i++) {
            const d = new Date(year, month, -firstDay.getDay() + i + 1);
            days.push({
              date: d.toISOString().slice(0, 10),
              dayNum: d.getDate(),
              isCurrentMonth: false,
              isToday: false,
              cards: []
            });
          }
          
          const today = new Date().toISOString().slice(0, 10);
          for (let i = 1; i <= lastDay.getDate(); i++) {
            const d = new Date(year, month, i);
            const dateStr = d.toISOString().slice(0, 10);
            days.push({
              date: dateStr,
              dayNum: i,
              isCurrentMonth: true,
              isToday: dateStr === today,
              cards: displayCards.value.filter(c => c.dueDate === dateStr)
            });
          }
          
          const remaining = 42 - days.length;
          for (let i = 1; i <= remaining; i++) {
            const d = new Date(year, month + 1, i);
            days.push({
              date: d.toISOString().slice(0, 10),
              dayNum: d.getDate(),
              isCurrentMonth: false,
              isToday: false,
              cards: []
            });
          }
          
          return days;
        });
        
        const ganttDates = computed(() => {
          const dates = [];
          const start = new Date();
          start.setDate(start.getDate() - 7);
          for (let i = 0; i < 30; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i);
            dates.push(d.toISOString().slice(0, 10));
          }
          return dates;
        });
        
        const allAssignees = computed(() => {
          const assignees = new Set();
          cards.value.forEach(c => {
            if (c.assignee) assignees.add(c.assignee);
          });
          return Array.from(assignees);
        });
        
        const filteredGanttCards = computed(() => {
          let filtered = displayCards.value.filter(c => c.dueDate || c.startDate);
          if (ganttFilterAssignee.value) {
            filtered = filtered.filter(c => c.assignee === ganttFilterAssignee.value);
          }
          return filtered;
        });

        // === å·¥å…·å‡½å¼ ===
        const showToast = (message, type = 'info') => {
          toast.value = { show: true, message, type };
          setTimeout(() => { toast.value.show = false; }, 3000);
        };
        
        const generateId = () => {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };
        
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const d = new Date(dateStr);
          return `${d.getMonth() + 1}/${d.getDate()}`;
        };
        
        const formatDateTime = (timestamp) => {
          if (!timestamp) return '';
          const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return d.toLocaleString('zh-TW');
        };
        
        const getDueDateClass = (dateStr) => {
          if (!dateStr) return '';
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const due = new Date(dateStr);
          const diff = (due - today) / (1000 * 60 * 60 * 24);
          
          if (diff < 0) return 'text-red-600 font-medium';
          if (diff <= 2) return 'text-orange-500';
          return 'text-gray-500';
        };
        
        const getLabelBgClass = (label) => {
          const classes = {
            urgent: 'bg-red-500',
            important: 'bg-yellow-500',
            normal: 'bg-green-500',
            feature: 'bg-blue-500',
            bug: 'bg-purple-500'
          };
          return classes[label] || 'bg-gray-500';
        };
        
        const isToday = (dateStr) => {
          return dateStr === new Date().toISOString().slice(0, 10);
        };
        
        const getGanttBarStyle = (card) => {
          const startDate = card.startDate || card.dueDate;
          const endDate = card.dueDate || card.startDate;
          
          const startIndex = ganttDates.value.indexOf(startDate);
          const endIndex = ganttDates.value.indexOf(endDate);
          
          if (startIndex === -1 && endIndex === -1) return { display: 'none' };
          
          const left = Math.max(0, startIndex) * 32;
          const width = Math.max(1, (endIndex - startIndex + 1)) * 32;
          
          return {
            left: `${left}px`,
            width: `${Math.min(width, ganttDates.value.length * 32 - left)}px`
          };
        };

       // === Google ç™»å…¥åŠŸèƒ½ ===
        const signInWithGoogle = async () => {
          try {
            loading.value = true;
            error.value = '';
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
          } catch (err) {
            console.error('Google ç™»å…¥å¤±æ•—:', err);
            if (err.code === 'auth/popup-closed-by-user') {
              error.value = 'ç™»å…¥è¦–çª—å·²é—œé–‰ï¼Œè«‹é‡è©¦';
            } else if (err.code === 'auth/unauthorized-domain') {
              error.value = 'æ­¤ç¶²åŸŸæœªæˆæ¬Šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡';
            } else {
              error.value = 'ç™»å…¥å¤±æ•—ï¼š' + err.message;
            }
            showRetryLogin.value = true;
            loading.value = false;
          }
        };
        
        const signOut = async () => {
          try {
            await auth.signOut();
            currentUser.value = null;
            isAuthorized.value = false;
            role.value = '';
            boards.value = [];
            columns.value = [];
            cards.value = [];
            showToast('å·²ç™»å‡º', 'info');
          } catch (err) {
            console.error('ç™»å‡ºå¤±æ•—:', err);
            showToast('ç™»å‡ºå¤±æ•—', 'error');
          }
        };
        
        const checkAuthorization = async (user) => {
          try {
            const userDoc = await db.collection('authorized_users').doc(user.email).get();
            
            if (userDoc.exists) {
              isAuthorized.value = true;
              role.value = userDoc.data().role || 'member';
              
              await db.collection('authorized_users').doc(user.email).update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                displayName: user.displayName,
                photoURL: user.photoURL
              });
              
              return true;
            } else {
              const usersSnapshot = await db.collection('authorized_users').get();
              
              if (usersSnapshot.empty) {
                await db.collection('authorized_users').doc(user.email).set({
                  email: user.email,
                  role: 'admin',
                  displayName: user.displayName,
                  photoURL: user.photoURL,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                isAuthorized.value = true;
                role.value = 'admin';
                showToast('æ­¡è¿ï¼æ‚¨æ˜¯ç¬¬ä¸€ä½ä½¿ç”¨è€…ï¼Œå·²è‡ªå‹•è¨­ç‚ºç®¡ç†å“¡', 'success');
                return true;
              }
              
              isAuthorized.value = false;
              return false;
            }
          } catch (err) {
            console.error('æª¢æŸ¥æˆæ¬Šå¤±æ•—:', err);
            return false;
          }
        };
        
        // === ä½¿ç”¨è€…ç®¡ç†åŠŸèƒ½ ===
        const loadAuthorizedUsers = () => {
          unsubscribeUsers = db.collection('authorized_users')
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
              authorizedUsers.value = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
            });
        };
        
        const addUser = async () => {
          if (!newUserEmail.value.trim()) {
            showToast('è«‹è¼¸å…¥ Email', 'error');
            return;
          }
          
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(newUserEmail.value.trim())) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼', 'error');
            return;
          }
          
          const email = newUserEmail.value.trim().toLowerCase();
          
          try {
            const existingUser = await db.collection('authorized_users').doc(email).get();
            if (existingUser.exists) {
              showToast('æ­¤ Email å·²åœ¨æˆæ¬Šåå–®ä¸­', 'error');
              return;
            }
            
            await db.collection('authorized_users').doc(email).set({
              email: email,
              role: newUserRole.value,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: currentUser.value.email
            });
            
            newUserEmail.value = '';
            newUserRole.value = 'member';
            showToast('ä½¿ç”¨è€…å·²æ–°å¢', 'success');
          } catch (err) {
            console.error('æ–°å¢ä½¿ç”¨è€…å¤±æ•—:', err);
            showToast('æ–°å¢ä½¿ç”¨è€…å¤±æ•—', 'error');
          }
        };
        
        const updateUserRole = async (user, newRole) => {
          try {
            await db.collection('authorized_users').doc(user.email).update({
              role: newRole
            });
            showToast('è§’è‰²å·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°è§’è‰²å¤±æ•—:', err);
            showToast('æ›´æ–°è§’è‰²å¤±æ•—', 'error');
          }
        };
        
        const removeUser = async (user) => {
          if (!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${user.email}ã€çš„æˆæ¬Šå—ï¼Ÿ`)) return;
          
          try {
            await db.collection('authorized_users').doc(user.email).delete();
            showToast('ä½¿ç”¨è€…å·²ç§»é™¤', 'success');
          } catch (err) {
            console.error('ç§»é™¤ä½¿ç”¨è€…å¤±æ•—:', err);
            showToast('ç§»é™¤ä½¿ç”¨è€…å¤±æ•—', 'error');
          }
        };

        // === åˆå§‹åŒ– ===
        const initialize = async () => {
          auth.onAuthStateChanged(async (user) => {
            loading.value = true;
            error.value = '';
            showRetryLogin.value = false;
            
            if (user) {
              currentUser.value = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL
              };
              
              const authorized = await checkAuthorization(user);
              
              if (authorized) {
                startListening();
                loadAuthorizedUsers();
              }
            } else {
              currentUser.value = null;
              isAuthorized.value = false;
              role.value = '';
            }
            
            loading.value = false;
          });
        };

        // === è³‡æ–™ç›£è½ ===
        const startListening = () => {
          unsubscribeBoards = db.collection('boards')
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
              boards.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              
              if (!currentBoardId.value && boards.value.length > 0) {
                currentBoardId.value = boards.value[0].id;
              }
            });
        };
        
        const startBoardListening = (boardId) => {
          if (unsubscribeColumns) unsubscribeColumns();
          if (unsubscribeCards) unsubscribeCards();
          
          if (!boardId) {
            columns.value = [];
            cards.value = [];
            return;
          }
          
          unsubscribeColumns = db.collection('columns')
            .where('boardId', '==', boardId)
            .onSnapshot(snapshot => {
              columns.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
          
          unsubscribeCards = db.collection('cards')
            .where('boardId', '==', boardId)
            .onSnapshot(snapshot => {
              cards.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        };
        
        watch(currentBoardId, (newId) => {
          startBoardListening(newId);
        });
        
        let unsubscribeAllCardsListener = null;
        
        const startAllCardsListening = () => {
          if (unsubscribeAllCardsListener) unsubscribeAllCardsListener();
          
          unsubscribeAllCardsListener = db.collection('cards')
            .onSnapshot(snapshot => {
              allBoardsCards.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        };
        
        watch(showAllBoards, (newVal) => {
          if (newVal) {
            startAllCardsListening();
          } else {
            if (unsubscribeAllCardsListener) {
              unsubscribeAllCardsListener();
              unsubscribeAllCardsListener = null;
            }
            allBoardsCards.value = [];
          }
        });

        // === çœ‹æ¿åŠŸèƒ½ ===
        const createBoard = async () => {
          if (!newBoardName.value.trim()) return;
          
          try {
            const boardId = generateId();
            await db.collection('boards').doc(boardId).set({
              name: newBoardName.value.trim(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: currentUser.value.email
            });
            
            currentBoardId.value = boardId;
            newBoardName.value = '';
            showNewBoardModal.value = false;
            showToast('çœ‹æ¿å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹çœ‹æ¿å¤±æ•—:', err);
            showToast('å»ºç«‹çœ‹æ¿å¤±æ•—', 'error');
          }
        };
        
        const deleteBoard = async () => {
          if (!currentBoardId.value) return;
          
          const board = boards.value.find(b => b.id === currentBoardId.value);
          if (!board) return;
          
          const confirmMsg = `ç¢ºå®šè¦åˆªé™¤ã€Œ${board.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒåˆªé™¤è©²çœ‹æ¿å…§çš„æ‰€æœ‰æ¬„ä½å’Œå¡ç‰‡ï¼Œä¸”ç„¡æ³•å¾©åŸï¼`;
          if (!confirm(confirmMsg)) return;
          
          try {
            const batch = db.batch();
            
            const cardsToDelete = cards.value.filter(c => c.boardId === currentBoardId.value);
            for (const card of cardsToDelete) {
              batch.delete(db.collection('cards').doc(card.id));
            }
            
            const columnsToDelete = columns.value.filter(c => c.boardId === currentBoardId.value);
            for (const column of columnsToDelete) {
              batch.delete(db.collection('columns').doc(column.id));
            }
            
            batch.delete(db.collection('boards').doc(currentBoardId.value));
            
            await batch.commit();
            
            currentBoardId.value = '';
            columns.value = [];
            cards.value = [];
            showToast('çœ‹æ¿å·²åˆªé™¤', 'success');
          } catch (err) {
            console.error('åˆªé™¤çœ‹æ¿å¤±æ•—:', err);
            showToast('åˆªé™¤çœ‹æ¿å¤±æ•—', 'error');
          }
        };

        // === æ¬„ä½åŠŸèƒ½ ===
        const createColumn = async () => {
          if (!newColumnName.value.trim() || !currentBoardId.value) return;
          
          try {
            const maxOrder = columns.value.length > 0 
              ? Math.max(...columns.value.map(c => c.orderIndex || 0)) 
              : 0;
            
            await db.collection('columns').doc(generateId()).set({
              boardId: currentBoardId.value,
              name: newColumnName.value.trim(),
              color: newColumnColor.value,
              orderIndex: maxOrder + 1,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            newColumnName.value = '';
            newColumnColor.value = '#6366f1';
            showNewColumnModal.value = false;
            showToast('æ¬„ä½å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹æ¬„ä½å¤±æ•—:', err);
            showToast('å»ºç«‹æ¬„ä½å¤±æ•—', 'error');
          }
        };
        
        const openColumnMenu = (column) => {
          selectedColumn.value = column;
          showColumnMenu.value = true;
        };
        
        const openEditColumnModal = () => {
          editingColumn.value = { ...selectedColumn.value };
          showColumnMenu.value = false;
          showEditColumnModal.value = true;
        };
        
        const saveColumn = async () => {
          try {
            await db.collection('columns').doc(editingColumn.value.id).update({
              name: editingColumn.value.name,
              color: editingColumn.value.color
            });
            showEditColumnModal.value = false;
            showToast('æ¬„ä½å·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°æ¬„ä½å¤±æ•—:', err);
            showToast('æ›´æ–°æ¬„ä½å¤±æ•—', 'error');
          }
        };
        
        const confirmArchiveColumn = () => {
          archivingColumn.value = selectedColumn.value;
          showColumnMenu.value = false;
          showArchiveConfirm.value = true;
        };
        
        const archiveColumn = async () => {
          try {
            const batch = db.batch();
            
            const cardsToDelete = cards.value.filter(c => c.columnId === archivingColumn.value.id);
            for (const card of cardsToDelete) {
              batch.delete(db.collection('cards').doc(card.id));
            }
            
            batch.delete(db.collection('columns').doc(archivingColumn.value.id));
            
            await batch.commit();
            showArchiveConfirm.value = false;
            showToast('æ¬„ä½å·²åˆªé™¤', 'success');
          } catch (err) {
            console.error('åˆªé™¤æ¬„ä½å¤±æ•—:', err);
            showToast('åˆªé™¤æ¬„ä½å¤±æ•—', 'error');
          }
        };

        // === å¡ç‰‡åŠŸèƒ½ ===
        const openNewCardModal = (column) => {
          selectedColumnForNewCard.value = column;
          showNewCardModal.value = true;
        };
        
        const createCard = async () => {
          if (!newCardTitle.value.trim() || !selectedColumnForNewCard.value) return;
          
          try {
            const columnCards = cards.value.filter(c => c.columnId === selectedColumnForNewCard.value.id);
            const maxOrder = columnCards.length > 0 
              ? Math.max(...columnCards.map(c => c.orderIndex || 0)) 
              : 0;
            
            await db.collection('cards').doc(generateId()).set({
              boardId: currentBoardId.value,
              columnId: selectedColumnForNewCard.value.id,
              title: newCardTitle.value.trim(),
              description: '',
              labels: [],
              checklist: [],
              images: [],
              files: [],
              externalLinks: [],
              orderIndex: maxOrder + 1,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: currentUser.value.email
            });
            
            newCardTitle.value = '';
            showNewCardModal.value = false;
            showToast('å¡ç‰‡å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹å¡ç‰‡å¤±æ•—:', err);
            showToast('å»ºç«‹å¡ç‰‡å¤±æ•—', 'error');
          }
        };
        
        const openCardDetail = async (card) => {
          editingCard.value = { 
            ...JSON.parse(JSON.stringify(card)),
            images: card.images || [],
            files: card.files || [],
            externalLinks: card.externalLinks || [],
            checklist: card.checklist || [],
            labels: card.labels || []
          };
          showCardDetail.value = true;
          
          try {
            const snapshot = await db.collection('comments')
              .where('cardId', '==', card.id)
              .orderBy('createdAt', 'desc')
              .get();
            cardComments.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          } catch (err) {
            console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', err);
            cardComments.value = [];
          }
        };
        
        const closeCardDetail = () => {
          showCardDetail.value = false;
          editingCard.value = {};
          cardComments.value = [];
          showAddExternalLink.value = false;
          newExternalLink.value = { name: '', url: '' };
        };
        
        const saveCard = async () => {
          try {
            const cardData = { ...editingCard.value };
            delete cardData.id;
            
            await db.collection('cards').doc(editingCard.value.id).update(cardData);
            showToast('å¡ç‰‡å·²å„²å­˜', 'success');
            closeCardDetail();
          } catch (err) {
            console.error('å„²å­˜å¡ç‰‡å¤±æ•—:', err);
            showToast('å„²å­˜å¡ç‰‡å¤±æ•—', 'error');
          }
        };
        
        const deleteCard = async () => {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿ')) return;
          
          try {
            await db.collection('cards').doc(editingCard.value.id).delete();
            showToast('å¡ç‰‡å·²åˆªé™¤', 'success');
            closeCardDetail();
          } catch (err) {
            console.error('åˆªé™¤å¡ç‰‡å¤±æ•—:', err);
            showToast('åˆªé™¤å¡ç‰‡å¤±æ•—', 'error');
          }
        };
        
        const toggleLabel = (label) => {
          if (!editingCard.value.labels) {
            editingCard.value.labels = [];
          }
          const index = editingCard.value.labels.indexOf(label);
          if (index === -1) {
            editingCard.value.labels.push(label);
          } else {
            editingCard.value.labels.splice(index, 1);
          }
        };

        // === ç•™è¨€åŠŸèƒ½ ===
        const addComment = async () => {
          if (!newComment.value.trim() || !editingCard.value.id) return;
          
          try {
            await db.collection('comments').doc(generateId()).set({
              cardId: editingCard.value.id,
              content: newComment.value.trim(),
              author: currentUser.value.displayName || currentUser.value.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            newComment.value = '';
            
            const snapshot = await db.collection('comments')
              .where('cardId', '==', editingCard.value.id)
              .orderBy('createdAt', 'desc')
              .get();
            cardComments.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            showToast('ç•™è¨€å·²é€å‡º', 'success');
          } catch (err) {
            console.error('é€å‡ºç•™è¨€å¤±æ•—:', err);
            showToast('é€å‡ºç•™è¨€å¤±æ•—', 'error');
          }
        };

        // === ä¸Šå‚³åŠŸèƒ½ ===
        const uploadImage = async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          uploading.value = true;
          try {
            const fileRef = storage.ref().child(`images/${generateId()}_${file.name}`);
            await fileRef.put(file);
            const url = await fileRef.getDownloadURL();
            
            if (!editingCard.value.images) {
              editingCard.value.images = [];
            }
            editingCard.value.images.push(url);
            showToast('åœ–ç‰‡å·²ä¸Šå‚³', 'success');
          } catch (err) {
            console.error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—:', err);
            showToast('ä¸Šå‚³å¤±æ•—ï¼šSpark æ–¹æ¡ˆä¸æ”¯æ´ Storage', 'error');
          } finally {
            uploading.value = false;
            event.target.value = '';
          }
        };
        
        const removeImage = (index) => {
          editingCard.value.images.splice(index, 1);
        };
        
        const uploadFile = async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          uploading.value = true;
          try {
            const fileRef = storage.ref().child(`files/${generateId()}_${file.name}`);
            await fileRef.put(file);
            const url = await fileRef.getDownloadURL();
            
            if (!editingCard.value.files) {
              editingCard.value.files = [];
            }
            editingCard.value.files.push({ name: file.name, url });
            showToast('æª”æ¡ˆå·²ä¸Šå‚³', 'success');
          } catch (err) {
            console.error('ä¸Šå‚³æª”æ¡ˆå¤±æ•—:', err);
            showToast('ä¸Šå‚³å¤±æ•—ï¼šSpark æ–¹æ¡ˆä¸æ”¯æ´ Storage', 'error');
          } finally {
            uploading.value = false;
            event.target.value = '';
          }
        };
        
        const removeFile = (index) => {
          editingCard.value.files.splice(index, 1);
        };

        // === å¤–éƒ¨é€£çµåŠŸèƒ½ ===
        const addExternalLink = () => {
          if (!newExternalLink.value.url) {
            showToast('è«‹è¼¸å…¥é€£çµç¶²å€', 'error');
            return;
          }
          
          try {
            new URL(newExternalLink.value.url);
          } catch {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€', 'error');
            return;
          }
          
          if (!editingCard.value.externalLinks) {
            editingCard.value.externalLinks = [];
          }
          
          editingCard.value.externalLinks.push({
            name: newExternalLink.value.name || newExternalLink.value.url,
            url: newExternalLink.value.url,
            addedAt: new Date().toISOString()
          });
          
          newExternalLink.value = { name: '', url: '' };
          showAddExternalLink.value = false;
          showToast('å·²æ–°å¢å¤–éƒ¨é€£çµ', 'success');
        };
        
        const removeExternalLink = (index) => {
          if (editingCard.value.externalLinks) {
            editingCard.value.externalLinks.splice(index, 1);
            showToast('å·²ç§»é™¤é€£çµ', 'success');
          }
        };

        // === åŒ¯å‡ºå‚™ä»½åŠŸèƒ½ ===
        const exportBackup = async () => {
          try {
            showToast('æ­£åœ¨æº–å‚™å‚™ä»½è³‡æ–™...', 'info');
            
            const backupData = {
              exportDate: new Date().toISOString(),
              projectName: 'Kanban-schedule',
              version: '1.0',
              data: {
                boards: boards.value,
                columns: columns.value,
                cards: cards.value
              }
            };
            
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanban-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰ï¼', 'success');
          } catch (err) {
            console.error('åŒ¯å‡ºå‚™ä»½å¤±æ•—:', err);
            showToast('åŒ¯å‡ºå‚™ä»½å¤±æ•—', 'error');
          }
        };

        // === åŒ¯å…¥å‚™ä»½åŠŸèƒ½ ===
        const openImportModal = () => {
          showImportModal.value = true;
          importPreview.value = null;
          importMode.value = 'merge';
        };
        
        const closeImportModal = () => {
          showImportModal.value = false;
          importPreview.value = null;
          if (importFileInput.value) {
            importFileInput.value.value = '';
          }
        };
        
        const handleImportFile = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          if (!file.name.endsWith('.json')) {
            showToast('è«‹é¸æ“‡ JSON æª”æ¡ˆ', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              
              if (!data.data || !data.data.boards) {
                showToast('å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º', 'error');
                return;
              }
              
              importPreview.value = {
                exportDate: data.exportDate,
                boardCount: data.data.boards?.length || 0,
                columnCount: data.data.columns?.length || 0,
                cardCount: data.data.cards?.length || 0,
                rawData: data.data
              };
              
            } catch (err) {
              console.error('è§£æå‚™ä»½æª”æ¡ˆå¤±æ•—:', err);
              showToast('ç„¡æ³•è§£æå‚™ä»½æª”æ¡ˆ', 'error');
            }
          };
          reader.readAsText(file);
        };
        
        const executeImport = async () => {
          if (!importPreview.value) {
            showToast('è«‹å…ˆé¸æ“‡å‚™ä»½æª”æ¡ˆ', 'error');
            return;
          }
          
          const confirmMsg = importMode.value === 'merge' 
            ? 'ç¢ºå®šè¦åˆä½µåŒ¯å…¥å—ï¼Ÿç¾æœ‰è³‡æ–™æœƒä¿ç•™ï¼Œå‚™ä»½è³‡æ–™æœƒåŠ å…¥ï¼ˆçœ‹æ¿åç¨±åŠ ä¸Šã€Œ(åŒ¯å…¥)ã€ï¼‰ã€‚'
            : 'ç¢ºå®šè¦è¦†è“‹åŒ¯å…¥å—ï¼Ÿç¾æœ‰æ‰€æœ‰è³‡æ–™æœƒè¢«æ¸…é™¤ï¼';
          
          if (!confirm(confirmMsg)) return;
          
          try {
            showToast('æ­£åœ¨åŒ¯å…¥è³‡æ–™...', 'info');
            
            const batch = db.batch();
            const importData = importPreview.value.rawData;
            
            if (importMode.value === 'replace') {
              for (const card of cards.value) {
                batch.delete(db.collection('cards').doc(card.id));
              }
              for (const column of columns.value) {
                batch.delete(db.collection('columns').doc(column.id));
              }
              for (const board of boards.value) {
                batch.delete(db.collection('boards').doc(board.id));
              }
            }
            
            const boardIdMap = {};
            const columnIdMap = {};
            
            if (importData.boards) {
              for (const board of importData.boards) {
                const newId = importMode.value === 'merge' ? generateId() : board.id;
                boardIdMap[board.id] = newId;
                
                const docRef = db.collection('boards').doc(newId);
                batch.set(docRef, {
                  ...board,
                  id: newId,
                  name: importMode.value === 'merge' ? board.name + ' (åŒ¯å…¥)' : board.name,
                  importedAt: new Date().toISOString()
                });
              }
            }
            
            if (importData.columns) {
              for (const column of importData.columns) {
                const newId = importMode.value === 'merge' ? generateId() : column.id;
                columnIdMap[column.id] = newId;
                
                const docRef = db.collection('columns').doc(newId);
                batch.set(docRef, {
                  ...column,
                  id: newId,
                  boardId: boardIdMap[column.boardId] || column.boardId
                });
              }
            }
            
            if (importData.cards) {
              for (const card of importData.cards) {
                const newId = importMode.value === 'merge' ? generateId() : card.id;
                
                const docRef = db.collection('cards').doc(newId);
                batch.set(docRef, {
                  ...card,
                  id: newId,
                  boardId: boardIdMap[card.boardId] || card.boardId,
                  columnId: columnIdMap[card.columnId] || card.columnId
                });
              }
            }
            
            await batch.commit();
            
            showToast(`åŒ¯å…¥å®Œæˆï¼å…±åŒ¯å…¥ ${importPreview.value.boardCount} å€‹çœ‹æ¿ã€${importPreview.value.cardCount} å¼µå¡ç‰‡`, 'success');
            closeImportModal();
            
          } catch (err) {
            console.error('åŒ¯å…¥å¤±æ•—:', err);
            showToast('åŒ¯å…¥å¤±æ•—ï¼š' + err.message, 'error');
          }
        };

        // === å¡ç‰‡æ‹–æ‹‰åŠŸèƒ½ ===
        const onCardDragStart = (event, card) => {
          draggingCard.value = card;
          event.dataTransfer.effectAllowed = 'move';
          event.target.classList.add('card-dragging');
        };
        
        const onCardDragEnd = (event) => {
          draggingCard.value = null;
          event.target.classList.remove('card-dragging');
        };
        
        const onCardDragOver = (event, column) => {
          event.preventDefault();
          event.currentTarget.classList.add('drag-over');
        };
        
        const onCardDrop = async (event, column) => {
          event.currentTarget.classList.remove('drag-over');
          
          if (!draggingCard.value) return;
          if (draggingCard.value.columnId === column.id) return;
          
          try {
            const columnCards = cards.value.filter(c => c.columnId === column.id);
            const maxOrder = columnCards.length > 0 
              ? Math.max(...columnCards.map(c => c.orderIndex || 0)) 
              : 0;
            
            await db.collection('cards').doc(draggingCard.value.id).update({
              columnId: column.id,
              orderIndex: maxOrder + 1
            });
            
            showToast('å¡ç‰‡å·²ç§»å‹•', 'success');
          } catch (err) {
            console.error('ç§»å‹•å¡ç‰‡å¤±æ•—:', err);
            showToast('ç§»å‹•å¡ç‰‡å¤±æ•—', 'error');
          }
        };

        // === æ—¥æ›†åŠŸèƒ½ ===
        const prevMonth = () => {
          const d = new Date(calendarDate.value);
          d.setMonth(d.getMonth() - 1);
          calendarDate.value = d;
        };
        
        const nextMonth = () => {
          const d = new Date(calendarDate.value);
          d.setMonth(d.getMonth() + 1);
          calendarDate.value = d;
        };
        
        const onCalendarDrop = async (event, dateStr) => {
          if (!draggingCard.value) return;
          
          try {
            await db.collection('cards').doc(draggingCard.value.id).update({
              dueDate: dateStr
            });
            showToast('åˆ°æœŸæ—¥å·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°åˆ°æœŸæ—¥å¤±æ•—:', err);
            showToast('æ›´æ–°åˆ°æœŸæ—¥å¤±æ•—', 'error');
          }
        };

        // === ç”Ÿå‘½é€±æœŸ ===
        onMounted(() => {
          initialize();
        });
        
        onUnmounted(() => {
          if (unsubscribeBoards) unsubscribeBoards();
          if (unsubscribeColumns) unsubscribeColumns();
          if (unsubscribeCards) unsubscribeCards();
          if (unsubscribeAllCards) unsubscribeAllCards();
          if (unsubscribeAllCardsListener) unsubscribeAllCardsListener();
          if (unsubscribeUsers) unsubscribeUsers();
        });

        // === å›å‚³ ===
        return {
          loading,
          error,
          showRetryLogin,
          currentUser,
          isAuthorized,
          role,
          authorizedUsers,
          showUserManagement,
          newUserEmail,
          newUserRole,
          signInWithGoogle,
          signOut,
          addUser,
          updateUserRole,
          removeUser,
          boards,
          columns,
          cards,
          cardComments,
          currentBoardId,
          currentView,
          toast,
          showNewBoardModal,
          showNewColumnModal,
          showNewCardModal,
          showCardDetail,
          showColumnMenu,
          showEditColumnModal,
          showArchiveConfirm,
          showImportModal,
          editingCard,
          editingColumn,
          selectedColumn,
          archivingColumn,
          newBoardName,
          newColumnName,
          newColumnColor,
          newCardTitle,
          newComment,
          uploading,
          showAddExternalLink,
          newExternalLink,
          importMode,
          importFileInput,
          importPreview,
          draggingCard,
          calendarDate,
          ganttFilterAssignee,
          showAllBoards,
          showToolMenu,
          columnColors,
          labelNames,
          sortedColumns,
          calendarTitle,
          calendarDays,
          ganttDates,
          allAssignees,
          filteredGanttCards,
          formatDate,
          formatDateTime,
          getDueDateClass,
          getLabelBgClass,
          isToday,
          getGanttBarStyle,
          createBoard,
          deleteBoard,
          createColumn,
          openColumnMenu,
          openEditColumnModal,
          saveColumn,
          confirmArchiveColumn,
          archiveColumn,
          openNewCardModal,
          createCard,
          openCardDetail,
          closeCardDetail,
          saveCard,
          deleteCard,
          toggleLabel,
          addComment,
          uploadImage,
          removeImage,
          uploadFile,
          removeFile,
          addExternalLink,
          removeExternalLink,
          exportBackup,
          openImportModal,
          closeImportModal,
          handleImportFile,
          executeImport,
          onCardDragStart,
          onCardDragEnd,
          onCardDragOver,
          onCardDrop,
          prevMonth,
          nextMonth,
          onCalendarDrop
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
