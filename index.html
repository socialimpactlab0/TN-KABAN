<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°å—åœ˜éšŠçœ‹æ¿ç³»çµ±</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Noto Sans TC', sans-serif; }
    .drag-over { background-color: #e0e7ff !important; border: 2px dashed #6366f1 !important; }
    .card-dragging { opacity: 0.5; transform: rotate(3deg); }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .dark .scrollbar-thin::-webkit-scrollbar-track { background: #374151; }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #6b7280; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
  <div id="app">
    <!-- è¼‰å…¥ä¸­ -->
    <div v-if="loading" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-400">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div v-else-if="error" class="min-h-screen flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg text-center max-w-md">
        <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">ç„¡æ³•è¼‰å…¥</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">{{ error }}</p>
        <button v-if="showRetryLogin" @click="signInWithGoogle"
          class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">é‡æ–°ç™»å…¥</button>
      </div>
    </div>

    <!-- Google ç™»å…¥ç•«é¢ -->
    <div v-else-if="!currentUser" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 text-center">
        <div class="text-6xl mb-4">ğŸ“‹</div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">åœ˜éšŠå”ä½œç³»çµ±</h1>
        <p class="text-gray-500 mb-6">çœ‹æ¿ç®¡ç† Â· å…±åŒç·¨è¼¯ Â· å³æ™‚èŠå¤©</p>
        <button @click="signInWithGoogle"
          class="w-full py-3 px-4 bg-white border-2 border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center justify-center space-x-3">
          <svg class="w-6 h-6" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span class="text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
        </button>
        <p class="mt-6 text-sm text-gray-400">é¦–æ¬¡ç™»å…¥éœ€è¦ç®¡ç†å“¡æˆæ¬Š</p>
      </div>
    </div>

    <!-- æœªæˆæ¬Šç•«é¢ -->
    <div v-else-if="!isAuthorized" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 text-center">
        <div class="text-6xl mb-4">ğŸ”’</div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">å°šæœªæˆæ¬Š</h1>
        <p class="text-gray-500 mb-2">æ‚¨çš„å¸³è™Ÿå°šæœªè¢«æˆæ¬Šä½¿ç”¨æ­¤ç³»çµ±</p>
        <p class="text-gray-400 text-sm mb-6">{{ currentUser.email }}</p>
        <button @click="signOut" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ä½¿ç”¨å…¶ä»–å¸³è™Ÿç™»å…¥</button>
        <p class="mt-6 text-sm text-gray-400">è«‹è¯çµ¡ç®¡ç†å“¡å°‡æ‚¨çš„ Email åŠ å…¥æˆæ¬Šåå–®</p>
      </div>
    </div>

    <!-- ===== ä¸»ä»‹é¢ ===== -->
    <div v-else class="min-h-screen flex flex-col">
      <!-- é ‚éƒ¨å°èˆª -->
      <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 px-4 py-3">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200 whitespace-nowrap">ğŸ“‹ åœ˜éšŠå”ä½œ</h1>
            <div class="flex items-center space-x-2" v-if="currentView === 'board' || currentView === 'calendar' || currentView === 'gantt'">
              <select v-model="currentBoardId"
                class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none min-w-32">
                <option value="">é¸æ“‡çœ‹æ¿</option>
                <option v-for="board in boards" :key="board.id" :value="board.id">{{ board.name }}</option>
              </select>
              <button v-if="role === 'admin'" @click="showNewBoardModal = true"
                class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 whitespace-nowrap">+ æ–°å¢</button>
            </div>
          </div>

          <!-- è¦–åœ–åˆ‡æ› -->
          <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 overflow-x-auto">
            <button v-for="v in views" :key="v.id" @click="currentView = v.id"
              :class="currentView === v.id ? 'bg-white dark:bg-gray-600 shadow-sm' : ''"
              class="px-3 py-1 text-sm rounded-md transition-all whitespace-nowrap dark:text-gray-200">
              {{ v.icon }} {{ v.name }}
            </button>
          </div>

          <!-- å³å´å·¥å…· -->
          <div class="flex items-center space-x-3">
            <button @click="toggleDarkMode" class="px-2 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
              {{ darkMode ? 'â˜€ï¸' : 'ğŸŒ™' }}
            </button>
            <div class="relative">
              <button @click="showToolMenu = !showToolMenu"
                class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center space-x-1">
                <span>âš™ï¸ å·¥å…·</span><span class="text-xs">â–¼</span>
              </button>
              <div v-if="showToolMenu"
                class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
                <button @click="exportBackup(); showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                  <span>ğŸ“¥</span><span>åŒ¯å‡ºå‚™ä»½</span></button>
                <button v-if="role === 'admin'" @click="openImportModal(); showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                  <span>ğŸ“‚</span><span>åŒ¯å…¥å‚™ä»½</span></button>
                <div v-if="role === 'admin'" class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                <button v-if="role === 'admin'" @click="showUserManagement = true; showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                  <span>ğŸ‘¥</span><span>ä½¿ç”¨è€…ç®¡ç†</span></button>
                <button @click="showThemeSettings = true; showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                  <span>ğŸ¨</span><span>ä¸»é¡Œè¨­å®š</span></button>
                <button v-if="role === 'admin' && currentBoardId" @click="deleteBoard(); showToolMenu = false"
                  class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center space-x-2">
                  <span>ğŸ—‘ï¸</span><span>åˆªé™¤çœ‹æ¿</span></button>
              </div>
            </div>
            <div class="flex items-center space-x-2 pl-3 border-l border-gray-200 dark:border-gray-700">
              <img :src="currentUser.photoURL" class="w-8 h-8 rounded-full" v-if="currentUser.photoURL">
              <div class="hidden sm:block">
                <div class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ currentUser.displayName || currentUser.email }}</div>
                <div class="text-xs text-gray-500">{{ role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡' }}</div>
              </div>
              <button @click="signOut" class="px-2 py-1 text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">ç™»å‡º</button>
            </div>
          </div>
        </div>
      </header>

      <!-- ===== ä¸»è¦å…§å®¹å€ ===== -->
      <main class="flex-1 overflow-hidden">

        <!-- ===== çœ‹æ¿è¦–åœ– ===== -->
        <div v-if="currentView === 'board'" class="h-full p-4 overflow-x-auto">
          <div class="flex space-x-4 h-full">
            <div v-for="column in sortedColumns" :key="column.id"
              class="flex-shrink-0 w-80 bg-gray-100 dark:bg-gray-800 rounded-xl flex flex-col max-h-full"
              @dragover.prevent="$event.currentTarget.classList.add('drag-over')"
              @dragleave="$event.currentTarget.classList.remove('drag-over')"
              @drop="onCardDrop($event, column)">
              <div class="p-3 font-medium flex items-center justify-between" :style="{ borderTop: '3px solid ' + (column.color || '#6366f1') }">
                <div class="flex items-center">
                  <span class="dark:text-gray-200">{{ column.name }}</span>
                  <span class="ml-2 text-xs text-gray-500 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">
                    {{ cards.filter(c => c.columnId === column.id).length }}
                  </span>
                </div>
                <div class="flex items-center space-x-1">
                  <button @click="openNewCardModal(column)" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded">â•</button>
                  <button v-if="role === 'admin'" @click="openColumnMenu(column)" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded">âš™ï¸</button>
                </div>
              </div>
              <div class="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">
                <div v-for="card in cards.filter(c => c.columnId === column.id).sort((a, b) => a.orderIndex - b.orderIndex)"
                  :key="card.id" draggable="true"
                  @dragstart="onCardDragStart($event, card)" @dragend="onCardDragEnd"
                  @click="openCardDetail(card)"
                  class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer transition-shadow border border-gray-200 dark:border-gray-600"
                  :class="{ 'card-dragging': draggingCard?.id === card.id }">
                  <div v-if="card.labels && card.labels.length > 0" class="flex flex-wrap gap-1 mb-2">
                    <span v-for="label in card.labels" :key="label"
                      class="px-2 py-0.5 text-xs rounded-full text-white"
                      :class="getLabelBgClass(label)">{{ labelNames[label] || label }}</span>
                  </div>
                  <h4 class="font-medium text-gray-800 dark:text-gray-200 line-clamp-2">{{ card.title }}</h4>
                  <p v-if="card.description" class="text-sm text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">{{ card.description }}</p>
                  <div class="flex items-center justify-between mt-2 text-xs text-gray-400">
                    <div class="flex items-center space-x-2">
                      <span v-if="card.dueDate" :class="getDueDateClass(card.dueDate)">ğŸ“… {{ formatDate(card.dueDate) }}</span>
                      <span v-if="card.checklist && card.checklist.length > 0">âœ… {{ card.checklist.filter(i => i.done).length }}/{{ card.checklist.length }}</span>
                    </div>
                    <span v-if="card.assignee" class="text-gray-500">ğŸ‘¤ {{ card.assignee }}</span>
                  </div>
                </div>
                <div v-if="cards.filter(c => c.columnId === column.id).length === 0"
                  class="text-center text-gray-400 text-sm py-8">æ‹–æ‹‰å¡ç‰‡åˆ°é€™è£¡</div>
              </div>
            </div>
            <div v-if="role === 'admin'" class="flex-shrink-0 w-80">
              <button @click="showNewColumnModal = true"
                class="w-full p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-gray-500 hover:border-indigo-500 hover:text-indigo-500 transition-colors">+ æ–°å¢æ¬„ä½</button>
            </div>
          </div>
        </div>

        <!-- ===== æ—¥æ›†è¦–åœ– ===== -->
        <div v-if="currentView === 'calendar'" class="h-full p-4 overflow-auto">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
            <div class="flex items-center justify-between mb-4">
              <button @click="prevMonth" class="px-3 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg dark:text-gray-200">â—€</button>
              <h3 class="text-lg font-medium dark:text-gray-200">{{ calendarTitle }}</h3>
              <button @click="nextMonth" class="px-3 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg dark:text-gray-200">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 mb-2">
              <div v-for="day in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" :key="day" class="text-center text-sm font-medium text-gray-500 py-2">{{ day }}</div>
            </div>
            <div class="grid grid-cols-7 gap-1">
              <div v-for="day in calendarDays" :key="day.date"
                class="min-h-24 border border-gray-100 dark:border-gray-700 rounded-lg p-1"
                :class="{ 'bg-gray-50 dark:bg-gray-900': !day.isCurrentMonth, 'bg-blue-50 dark:bg-blue-900/30': day.isToday }"
                @dragover.prevent @drop="onCalendarDrop($event, day.date)">
                <div class="text-xs text-gray-500 mb-1">{{ day.dayNum }}</div>
                <div class="space-y-1">
                  <div v-for="card in day.cards" :key="card.id" draggable="true"
                    @dragstart="onCardDragStart($event, card)" @click="openCardDetail(card)"
                    class="text-xs p-1 rounded truncate cursor-pointer hover:bg-indigo-200"
                    :class="card._label === 'é–‹å§‹' ? 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300' : 
                    'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300'">{{ card._label === 'é–‹å§‹' ? 'â–¶' : 'â– ' }} {{ card.title }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== ç”˜ç‰¹åœ–è¦–åœ– ===== -->
        <div v-if="currentView === 'gantt'" class="h-full p-4 overflow-auto">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium dark:text-gray-200">ğŸ“Š ç”˜ç‰¹åœ–</h3>
              <select v-model="ganttFilterAssignee" class="px-3 py-1.5 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200">
                <option value="">æ‰€æœ‰æˆå“¡</option>
                <option v-for="a in allAssignees" :key="a" :value="a">{{ a }}</option>
              </select>
            </div>
            <div class="overflow-x-auto">
              <div class="min-w-max">
                <div class="flex border-b dark:border-gray-700">
                  <div class="w-48 flex-shrink-0 p-2 font-medium text-sm text-gray-600 dark:text-gray-400">ä»»å‹™</div>
                  <div class="flex">
                    <div v-for="date in ganttDates" :key="date"
  class="w-8 p-1 text-center text-xs text-gray-500 border-l dark:border-gray-700"
  :class="{ 'bg-blue-50 dark:bg-blue-900/30': isToday(date) }">{{ parseInt(date.split('-')[2]) }}</div>
                  </div>
                </div>
                <div v-for="card in filteredGanttCards" :key="card.id" class="flex border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                  <div class="w-48 flex-shrink-0 p-2 text-sm truncate cursor-pointer hover:text-indigo-600 dark:text-gray-200" @click="openCardDetail(card)">{{ card.title }}</div>
                  <div class="flex">
  <div v-for="date in ganttDates" :key="date" class="w-8 h-8 border-l dark:border-gray-700"
    :class="{
      'bg-blue-50 dark:bg-blue-900/30': isToday(date) && !(card.startDate && card.dueDate && date >= card.startDate && date <= card.dueDate),
      'bg-indigo-400': card.startDate && card.dueDate && date >= card.startDate && date <= card.dueDate,
      'rounded-l': card.startDate && date === card.startDate,
      'rounded-r': card.dueDate && date === card.dueDate
                     }"></div>
                     </div> 
                </div>
                <div v-if="filteredGanttCards.length === 0" class="text-center text-gray-400 py-8 text-sm">æ²’æœ‰è¨­å®šæ—¥æœŸçš„ä»»å‹™</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== å…±åŒç·¨è¼¯è¦–åœ– (æ–°å¢) ===== -->
        <div v-if="currentView === 'docs'" class="h-full p-4 overflow-auto">
          <!-- åœ¨ç·šç”¨æˆ¶ -->
          <div class="flex items-center gap-2 mb-3 flex-wrap">
            <span class="text-sm text-gray-500 dark:text-gray-400">åœ¨ç·šï¼š</span>
            <span v-for="u in onlineUsers" :key="u.id"
              class="inline-flex items-center gap-1 bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 px-2 py-0.5 rounded-full text-xs">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>{{ u.name }}
            </span>
          </div>

          <!-- æ–‡ä»¶é ç±¤ -->
          <div class="flex items-center gap-2 mb-3 flex-wrap">
            <button v-for="d in docList" :key="d.id" @click="switchDoc(d.id)"
              class="px-3 py-1.5 rounded-full text-sm border transition-colors"
              :class="currentDocId === d.id ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:border-indigo-500'">
              {{ d.title || 'æœªå‘½å' }}
              <span v-if="d.id !== 'main'" @click.stop="removeDoc(d.id)" class="ml-1 opacity-50 hover:opacity-100">âœ•</span>
            </button>
            <button @click="createDoc" class="px-3 py-1.5 rounded-full text-sm border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-500 hover:border-indigo-500 hover:text-indigo-500">+ æ–°æ–‡ä»¶</button>
          </div>

          <!-- å·¥å…·åˆ— -->
          <div class="flex items-center gap-2 mb-3 flex-wrap">
            <button @click="createMeetingDoc" class="px-3 py-1.5 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">ğŸ“ æœƒè­°è¨˜éŒ„</button>
            <button @click="exportDoc" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">ğŸ’¾ åŒ¯å‡º</button>
            <button @click="toggleDocLock" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">
              {{ docLocked ? 'ğŸ”“ è§£é–' : 'ğŸ”’ é–å®š' }}
            </button>
            <button @click="showDocVersions" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">ğŸ• ç‰ˆæœ¬</button>
            <span class="text-sm text-gray-400 ml-auto">{{ docSaveStatus }}</span>
          </div>

          <!-- ç·¨è¼¯å™¨ -->
          <textarea v-model="docContent" @input="onDocInput"
            class="w-full min-h-[400px] p-4 border-2 rounded-xl text-sm leading-relaxed outline-none resize-y transition-colors"
            :class="docLocked ? 'bg-gray-100 dark:bg-gray-900 text-gray-400 border-gray-200 dark:border-gray-700' : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-600 focus:border-indigo-500'"
            :readonly="docLocked"
            placeholder="åœ¨é€™è£¡è¼¸å…¥å…§å®¹ï¼Œæ‰€æœ‰æˆå“¡éƒ½èƒ½å³æ™‚çœ‹åˆ°..."></textarea>
        </div>

        <!-- ===== èŠå¤©å®¤è¦–åœ– (æ–°å¢) ===== -->
        <div v-if="currentView === 'chat'" class="h-full p-4 flex justify-center">
          <div class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden flex flex-col" style="height: calc(100vh - 140px);">
            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="chatBox">
              <div v-for="msg in chatMessages" :key="msg.id" class="flex gap-2">
                <img :src="msg.photo || ''" class="w-8 h-8 rounded-full mt-1 flex-shrink-0">
                <div class="flex-1">
                  <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded-xl inline-block max-w-[80%]">
                    <div class="text-xs font-semibold text-indigo-600 dark:text-indigo-400">{{ msg.name }}</div>
                    <div class="text-sm text-gray-800 dark:text-gray-200 mt-0.5 whitespace-pre-wrap">{{ msg.text }}</div>
                    <div class="text-xs text-gray-400 mt-1">{{ formatMsgTime(msg.time) }}</div>
                  </div>
                  <div v-if="msg.readBy && msg.readBy.length > 1" class="text-xs text-gray-400 mt-0.5 ml-1">âœ“ å·²è®€ {{ msg.readBy.length - 1 }} äºº</div>
                </div>
              </div>
              <div v-if="chatMessages.length === 0" class="text-center text-gray-400 py-12">é‚„æ²’æœ‰è¨Šæ¯ï¼Œé–‹å§‹èŠå¤©å§ï¼</div>
            </div>
            <div class="border-t dark:border-gray-700 p-3 flex gap-2">
              <input v-model="chatInput" @keypress.enter="sendChat" type="text"
                class="flex-1 px-4 py-2 border dark:border-gray-600 rounded-full text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none focus:border-indigo-500"
                placeholder="è¼¸å…¥è¨Šæ¯...">
              <button @click="sendChat" class="px-5 py-2 bg-indigo-500 text-white rounded-full text-sm hover:bg-indigo-600">ç™¼é€</button>
            </div>
          </div>
        </div>

        <!-- ===== å…¬å‘Š / åˆ†äº«è¦–åœ– (æ–°å¢) ===== -->
        <div v-if="currentView === 'share'" class="h-full p-4 overflow-auto">
          <div class="max-w-3xl mx-auto">
            <!-- æœå°‹ -->
            <div class="relative mb-4">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
              <input v-model="noteSearch" type="text" placeholder="æœå°‹å…¬å‘Šã€ç­†è¨˜..."
                class="w-full pl-10 pr-4 py-2 border dark:border-gray-600 rounded-xl text-sm bg-white dark:bg-gray-800 dark:text-gray-200 outline-none focus:border-indigo-500">
            </div>
            <!-- æ–°å¢ -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-4 shadow-sm">
              <h3 class="font-medium text-gray-700 dark:text-gray-200 mb-3">ğŸ“ åˆ†äº«è³‡æ–™ / é€£çµ / å…¬å‘Š</h3>
              <input v-model="newNoteTitle" type="text" placeholder="æ¨™é¡Œ"
                class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm mb-2 bg-white dark:bg-gray-700 dark:text-gray-200 outline-none focus:border-indigo-500">
              <textarea v-model="newNoteContent" placeholder="å…§å®¹æˆ–é€£çµ..." rows="2"
                class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm mb-2 bg-white dark:bg-gray-700 dark:text-gray-200 outline-none focus:border-indigo-500 resize-none"></textarea>
              <div class="flex items-center justify-between">
                <label class="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
                  <input type="checkbox" v-model="newNotePinned" class="rounded"> ğŸ“Œ ç½®é ‚
                </label>
                <button @click="addNote" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">åˆ†äº«</button>
              </div>
            </div>
            <!-- åˆ—è¡¨ -->
            <div v-for="note in filteredNotes" :key="note.id"
              class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-3 shadow-sm"
              :class="{ 'border-l-4 border-yellow-400': note.pinned }">
              <div class="flex items-start justify-between">
                <div>
                  <h4 class="font-medium text-gray-800 dark:text-gray-200">
                    {{ note.title }}
                    <span v-if="note.pinned" class="ml-1 text-xs bg-yellow-400 text-white px-1.5 py-0.5 rounded">ğŸ“Œ ç½®é ‚</span>
                  </h4>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 whitespace-pre-wrap" v-html="linkifyText(note.content)"></p>
                </div>
              </div>
              <div class="flex items-center justify-between mt-3 text-xs text-gray-400">
                <span>{{ note.author }} Â· {{ formatNoteTime(note.createdAt) }}</span>
                <div class="flex gap-2">
                  <button @click="toggleNotePin(note)" class="hover:text-yellow-500">{{ note.pinned ? 'å–æ¶ˆç½®é ‚' : 'ğŸ“Œ ç½®é ‚' }}</button>
                  <button @click="deleteNote(note.id)" class="hover:text-red-500">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
              </div>
            </div>
            <div v-if="filteredNotes.length === 0" class="text-center text-gray-400 py-12">é‚„æ²’æœ‰åˆ†äº«çš„å…§å®¹</div>
          </div>
        </div>

        <!-- ===== å€‹äººå¾…è¾¦è¦–åœ– (æ–°å¢) ===== -->
        <div v-if="currentView === 'todo'" class="h-full p-4 overflow-auto">
          <div class="max-w-2xl mx-auto">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
              <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-4">âœ… æˆ‘çš„å¾…è¾¦æ¸…å–®</h3>
              <div class="flex gap-2 mb-4">
                <input v-model="newTodoText" @keypress.enter="addTodo" type="text" placeholder="æ–°å¢å¾…è¾¦äº‹é …..."
                  class="flex-1 px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none focus:border-indigo-500">
                <button @click="addTodo" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">æ–°å¢</button>
              </div>
              <div v-for="todo in myTodos" :key="todo.id"
                class="flex items-center gap-3 py-2 border-b dark:border-gray-700 last:border-b-0">
                <input type="checkbox" :checked="todo.done" @change="toggleTodo(todo)"
                  class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                <span class="flex-1 text-sm" :class="todo.done ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-200'">{{ todo.text }}</span>
                <button @click="deleteTodo(todo.id)" class="text-red-400 hover:text-red-600 text-sm">âœ•</button>
              </div>
              <div v-if="myTodos.length === 0" class="text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰å¾…è¾¦äº‹é …</div>
            </div>
          </div>
        </div>

        <!-- ===== æ´»å‹•ç´€éŒ„è¦–åœ– (æ–°å¢) ===== -->
        <div v-if="currentView === 'log'" class="h-full p-4 overflow-auto">
          <div class="max-w-3xl mx-auto">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
              <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-4">ğŸ“ˆ æ´»å‹•ç´€éŒ„</h3>
              <div v-for="log in activityLogs" :key="log.id"
                class="py-2 border-b dark:border-gray-700 last:border-b-0 text-sm">
                <span class="text-gray-400 mr-2">{{ formatLogTime(log.time) }}</span>
                <span class="font-semibold text-indigo-600 dark:text-indigo-400">{{ log.user }}</span>
                <span class="text-gray-600 dark:text-gray-400"> {{ log.action }}</span>
              </div>
              <div v-if="activityLogs.length === 0" class="text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰æ´»å‹•ç´€éŒ„</div>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- ===== æ‰€æœ‰å½ˆçª— Modal ===== -->

    <!-- æ–°å¢çœ‹æ¿ -->
    <div v-if="showNewBoardModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">æ–°å¢çœ‹æ¿</h3>
        <input v-model="newBoardName" type="text" placeholder="çœ‹æ¿åç¨±"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg mb-4 bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none"
          @keyup.enter="createBoard">
        <div class="flex justify-end space-x-2">
          <button @click="showNewBoardModal = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button @click="createBoard" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢æ¬„ä½ -->
    <div v-if="showNewColumnModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">æ–°å¢æ¬„ä½</h3>
        <input v-model="newColumnName" type="text" placeholder="æ¬„ä½åç¨±"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg mb-4 bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex space-x-2">
            <button v-for="color in columnColors" :key="color" @click="newColumnColor = color"
              class="w-8 h-8 rounded-full border-2"
              :class="newColumnColor === color ? 'border-gray-800 dark:border-white' : 'border-transparent'"
              :style="{ backgroundColor: color }"></button>
          </div>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="showNewColumnModal = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button @click="createColumn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢å¡ç‰‡ -->
    <div v-if="showNewCardModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">æ–°å¢å¡ç‰‡</h3>
        <input v-model="newCardTitle" type="text" placeholder="å¡ç‰‡æ¨™é¡Œ"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg mb-4 bg-white dark:bg-gray-700 dark:text-gray-200 outline-none"
          @keyup.enter="createCard">
        <div class="flex justify-end space-x-2">
          <button @click="showNewCardModal = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button @click="createCard" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ¬„ä½è¨­å®š -->
    <div v-if="showColumnMenu" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">æ¬„ä½è¨­å®šï¼š{{ selectedColumn?.name }}</h3>
        <div class="space-y-2">
          <button @click="openEditColumnModal" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg dark:text-gray-200">âœï¸ ç·¨è¼¯æ¬„ä½</button>
          <button @click="confirmArchiveColumn" class="w-full text-left px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 rounded-lg">ğŸ—‘ï¸ åˆªé™¤æ¬„ä½</button>
        </div>
        <button @click="showColumnMenu = false" class="mt-4 w-full py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- ç·¨è¼¯æ¬„ä½ -->
    <div v-if="showEditColumnModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">ç·¨è¼¯æ¬„ä½</h3>
        <input v-model="editingColumn.name" type="text" placeholder="æ¬„ä½åç¨±"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg mb-4 bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex space-x-2">
            <button v-for="color in columnColors" :key="color" @click="editingColumn.color = color"
              class="w-8 h-8 rounded-full border-2"
              :class="editingColumn.color === color ? 'border-gray-800 dark:border-white' : 'border-transparent'"
              :style="{ backgroundColor: color }"></button>
          </div>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="showEditColumnModal = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button @click="saveColumn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- åˆªé™¤æ¬„ä½ç¢ºèª -->
    <div v-if="showArchiveConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">ç¢ºèªåˆªé™¤</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">ç¢ºå®šè¦åˆªé™¤ã€Œ{{ archivingColumn?.name }}ã€æ¬„ä½å—ï¼Ÿ</p>
        <div class="flex justify-end space-x-2">
          <button @click="showArchiveConfirm = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button @click="archiveColumn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">åˆªé™¤</button>
        </div>
      </div>
    </div>

    <!-- å¡ç‰‡è©³æƒ… -->
    <div v-if="showCardDetail" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex items-center justify-between">
          <input v-model="editingCard.title" type="text"
            class="text-xl font-bold text-gray-800 dark:text-gray-200 bg-transparent border-none outline-none flex-1 mr-4" placeholder="å¡ç‰‡æ¨™é¡Œ">
          <button @click="closeCardDetail" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto">
          <div class="flex flex-col md:flex-row">
            <!-- å·¦å´ -->
            <div class="flex-1 p-4 space-y-4">
              <div>
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“ æè¿°</h4>
                <textarea v-model="editingCard.description" rows="3"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-gray-200 outline-none resize-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="æ–°å¢æè¿°..."></textarea>
              </div>
              <div>
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ”— å¤–éƒ¨é€£çµ</h4>
                <div v-for="(link, i) in editingCard.externalLinks" :key="i"
                  class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg mb-1 group">
                  <a :href="link.url" target="_blank" class="text-blue-600 hover:underline truncate flex-1 mr-2 text-sm">ğŸ“„ {{ link.name || link.url }}</a>
                  <button @click="editingCard.externalLinks.splice(i, 1)" class="text-red-500 opacity-0 group-hover:opacity-100">âœ•</button>
                </div>
                <div v-if="showAddLink" class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg mt-2">
                  <input v-model="newLinkName" type="text" placeholder="é€£çµåç¨±"
                    class="w-full px-3 py-2 border rounded-lg text-sm mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 outline-none">
                  <input v-model="newLinkUrl" type="url" placeholder="é€£çµç¶²å€"
                    class="w-full px-3 py-2 border rounded-lg text-sm mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 outline-none">
                  <div class="flex gap-2">
                    <button @click="addCardLink" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg">ç¢ºèª</button>
                    <button @click="showAddLink = false" class="px-3 py-1.5 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg">å–æ¶ˆ</button>
                  </div>
                </div>
                <button v-else @click="showAddLink = true" class="text-sm text-blue-600 hover:text-blue-800 mt-1">+ æ–°å¢å¤–éƒ¨é€£çµ</button>
              </div>
              <div>
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">âœ… æª¢æŸ¥æ¸…å–®</h4>
                <div v-for="(item, i) in editingCard.checklist" :key="i" class="flex items-center space-x-2 mb-1">
                  <input type="checkbox" v-model="item.done" class="w-4 h-4 text-indigo-600 rounded">
                  <input v-model="item.text" type="text"
                    class="flex-1 px-2 py-1 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none text-sm bg-transparent dark:text-gray-200"
                    :class="{ 'line-through text-gray-400': item.done }">
                  <button @click="editingCard.checklist.splice(i, 1)" class="text-red-500 text-sm">âœ•</button>
                </div>
                <button @click="editingCard.checklist = editingCard.checklist || []; editingCard.checklist.push({ text: '', done: false })"
                  class="mt-1 text-sm text-indigo-600 hover:text-indigo-800">+ æ–°å¢é …ç›®</button>
              </div>
              <div>
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ’¬ ç•™è¨€</h4>
                <div class="flex space-x-2 mb-3">
                  <input v-model="newComment" type="text" placeholder="è¼¸å…¥ç•™è¨€..."
                    class="flex-1 px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-gray-200 outline-none text-sm focus:ring-2 focus:ring-indigo-500"
                    @keyup.enter="addComment">
                  <button @click="addComment" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">é€å‡º</button>
                </div>
                <div v-for="c in cardComments" :key="c.id" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-2">
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm text-gray-800 dark:text-gray-200">{{ c.author }}</span>
                    <span class="text-xs text-gray-500">{{ formatDateTime(c.createdAt) }}</span>
                  </div>
                  <p class="text-gray-600 dark:text-gray-400 text-sm">{{ c.content }}</p>
                </div>
              </div>
            </div>
            <!-- å³å´ -->
            <div class="w-full md:w-64 p-4 bg-gray-50 dark:bg-gray-900 border-t md:border-t-0 md:border-l dark:border-gray-700 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç‹€æ…‹</label>
                <select v-model="editingCard.columnId"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
                  <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.name }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æŒ‡æ´¾äºº</label>
                <input v-model="editingCard.assignee" type="text" placeholder="è¼¸å…¥åå­—"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é–‹å§‹æ—¥æœŸ</label>
                <input v-model="editingCard.startDate" type="date"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">åˆ°æœŸæ—¥</label>
                <input v-model="editingCard.dueDate" type="date"
                  class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ¨™ç±¤</label>
                <div class="flex flex-wrap gap-2">
                  <button v-for="(name, key) in labelNames" :key="key" @click="toggleLabel(key)"
                    class="px-2 py-1 text-xs rounded-full transition-colors"
                    :class="editingCard.labels?.includes(key) ? 'text-white ' + getLabelBgClass(key) : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'">{{ name }}</button>
                </div>
              </div>
              <div class="pt-4 border-t dark:border-gray-700 space-y-2">
                <button @click="saveCard" class="w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                <button @click="deleteCard" class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ğŸ—‘ï¸ åˆªé™¤å¡ç‰‡</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨è€…ç®¡ç† -->
    <div v-if="showUserManagement" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</h3>
          <button @click="showUserManagement = false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
          <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <h4 class="font-medium text-gray-700 dark:text-gray-200 mb-3">æ–°å¢æˆæ¬Šä½¿ç”¨è€…</h4>
            <div class="flex space-x-2">
              <input v-model="newUserEmail" type="email" placeholder="è¼¸å…¥ Email"
                class="flex-1 px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200 outline-none"
                @keyup.enter="addUser">
              <select v-model="newUserRole" class="px-3 py-2 border dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-gray-200">
                <option value="member">æˆå“¡</option>
                <option value="admin">ç®¡ç†å“¡</option>
              </select>
              <button @click="addUser" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">æ–°å¢</button>
            </div>
          </div>
          <h4 class="font-medium text-gray-700 dark:text-gray-200 mb-3">å·²æˆæ¬Šä½¿ç”¨è€…ï¼ˆ{{ authorizedUsers.length }} äººï¼‰</h4>
          <div class="space-y-2">
            <div v-for="user in authorizedUsers" :key="user.id"
              class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-medium">
                  {{ user.email.charAt(0).toUpperCase() }}
                </div>
                <div>
                  <div class="font-medium text-gray-800 dark:text-gray-200">{{ user.email }}</div>
                  <div class="text-xs text-gray-500">{{ user.lastLogin ? 'ä¸Šæ¬¡ç™»å…¥ï¼š' + formatDateTime(user.lastLogin) : 'å°šæœªç™»å…¥' }}</div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <select :value="user.role" @change="updateUserRole(user, $event.target.value)"
                  class="px-2 py-1 border dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-600 dark:text-gray-200"
                  :disabled="user.email === currentUser.email">
                  <option value="member">æˆå“¡</option>
                  <option value="admin">ç®¡ç†å“¡</option>
                </select>
                <button v-if="user.email !== currentUser.email" @click="removeUser(user)" class="p-1 text-red-500 hover:text-red-700 rounded">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t dark:border-gray-700">
          <button @click="showUserManagement = false" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">é—œé–‰</button>
        </div>
      </div>
    </div>

    <!-- åŒ¯å…¥å‚™ä»½ -->
    <div v-if="showImportModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
          <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">ğŸ“‚ åŒ¯å…¥å‚™ä»½</h3>
        </div>
        <div class="p-4">
          <input ref="importFileInput" type="file" accept=".json" @change="handleImportFile"
            class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 dark:text-gray-200">
          <div v-if="importPreview" class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm">
            <p class="dark:text-gray-200">çœ‹æ¿ï¼š{{ importPreview.boardCount }} å€‹ Â· æ¬„ä½ï¼š{{ importPreview.columnCount }} å€‹ Â· å¡ç‰‡ï¼š{{ importPreview.cardCount }} å¼µ</p>
          </div>
          <div v-if="importPreview" class="space-y-2">
            <label class="flex items-start p-3 border dark:border-gray-600 rounded-lg cursor-pointer"
              :class="{ 'border-blue-500 bg-blue-50 dark:bg-blue-900/20': importMode === 'merge' }">
              <input type="radio" v-model="importMode" value="merge" class="mt-1 mr-3">
              <div><div class="font-medium dark:text-gray-200">åˆä½µåŒ¯å…¥</div><div class="text-sm text-gray-500">ä¿ç•™ç¾æœ‰è³‡æ–™</div></div>
            </label>
            <label class="flex items-start p-3 border dark:border-gray-600 rounded-lg cursor-pointer"
              :class="{ 'border-red-500 bg-red-50 dark:bg-red-900/20': importMode === 'replace' }">
              <input type="radio" v-model="importMode" value="replace" class="mt-1 mr-3">
              <div><div class="font-medium dark:text-gray-200">è¦†è“‹åŒ¯å…¥</div><div class="text-sm text-red-500">âš ï¸ æ¸…é™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™</div></div>
            </label>
          </div>
        </div>
        <div class="p-4 border-t dark:border-gray-700 flex justify-end space-x-2">
          <button @click="closeImportModal" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
          <button v-if="importPreview" @click="executeImport" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ç¢ºèªåŒ¯å…¥</button>
        </div>
      </div>
    </div>

    <!-- ä¸»é¡Œè¨­å®š -->
    <div v-if="showThemeSettings" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">ğŸ¨ ä¸»é¡Œè¨­å®š</h3>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">ä¸»é¡Œé¡è‰²</label>
          <div class="flex flex-wrap gap-3">
            <button v-for="c in themeColors" :key="c.name" @click="setThemeColor(c)"
              class="w-10 h-10 rounded-full border-3 transition-transform hover:scale-110"
              :class="themeColor === c.name ? 'border-gray-800 dark:border-white scale-110' : 'border-transparent'"
              :style="{ backgroundColor: c.primary }" :title="c.label"></button>
          </div>
        </div>
        <div class="mb-6">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" :checked="darkMode" @change="toggleDarkMode" class="w-5 h-5 text-indigo-600 rounded">
            <span class="text-gray-700 dark:text-gray-200">ğŸŒ™ æ·±è‰²æ¨¡å¼</span>
          </label>
        </div>
        <button @click="showThemeSettings = false" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">é—œé–‰</button>
      </div>
    </div>

    <!-- ç‰ˆæœ¬ç´€éŒ„ -->
    <div v-if="showVersionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b dark:border-gray-700">
          <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">ğŸ• ç‰ˆæœ¬ç´€éŒ„</h3>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div v-for="v in docVersions" :key="v.id" @click="restoreVersion(v)"
            class="p-3 border dark:border-gray-700 rounded-lg mb-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex justify-between items-center mb-1">
              <span class="font-medium text-sm text-gray-800 dark:text-gray-200">{{ v.editBy }}</span>
              <span class="text-xs text-gray-400">{{ formatLogTime(v.time) }}</span>
            </div>
            <p class="text-xs text-gray-500 truncate">{{ (v.content || '').substring(0, 80) }}...</p>
          </div>
          <div v-if="docVersions.length === 0" class="text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰ç‰ˆæœ¬ç´€éŒ„</div>
        </div>
        <div class="p-4 border-t dark:border-gray-700">
          <button @click="showVersionModal = false" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg">é—œé–‰</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div v-if="toast.show" class="fixed bottom-4 right-4 z-50">
      <div class="px-4 py-3 rounded-lg shadow-lg text-white"
        :class="{ 'bg-green-500': toast.type === 'success', 'bg-red-500': toast.type === 'error', 'bg-blue-500': toast.type === 'info' }">
        {{ toast.message }}
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted, onUnmounted, nextTick } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyA_CDIvCpgWH55WIL_PGUcKx5eyLIS_UpQ",
      authDomain: "tn-kanban.firebaseapp.com",
      projectId: "tn-kanban",
      storageBucket: "tn-kanban.firebasestorage.app",
      messagingSenderId: "827858027115",
      appId: "1:827858027115:web:613895649b718ca0a0672e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    createApp({
      setup() {
        // ===== åŸºç¤ç‹€æ…‹ =====
        const loading = ref(true);
        const error = ref('');
        const showRetryLogin = ref(false);
        const currentUser = ref(null);
        const isAuthorized = ref(false);
        const role = ref('');
        const authorizedUsers = ref([]);
        const showUserManagement = ref(false);
        const newUserEmail = ref('');
        const newUserRole = ref('member');

        // ===== çœ‹æ¿ç‹€æ…‹ =====
        const boards = ref([]);
        const columns = ref([]);
        const cards = ref([]);
        const cardComments = ref([]);
        const currentBoardId = ref('');
        const currentView = ref('board');
        const showAllBoards = ref(false);
        const allBoardsCards = ref([]);

        // ===== å½ˆçª—ç‹€æ…‹ =====
        const showNewBoardModal = ref(false);
        const showNewColumnModal = ref(false);
        const showNewCardModal = ref(false);
        const showCardDetail = ref(false);
        const showColumnMenu = ref(false);
        const showEditColumnModal = ref(false);
        const showArchiveConfirm = ref(false);
        const showImportModal = ref(false);
        const showToolMenu = ref(false);
        const showThemeSettings = ref(false);
        const showVersionModal = ref(false);

        // ===== ç·¨è¼¯ç‹€æ…‹ =====
        const editingCard = ref({});
        const editingColumn = ref({});
        const selectedColumn = ref(null);
        const archivingColumn = ref(null);
        const selectedColumnForNewCard = ref(null);
        const newBoardName = ref('');
        const newColumnName = ref('');
        const newColumnColor = ref('#6366f1');
        const newCardTitle = ref('');
        const newComment = ref('');
        const draggingCard = ref(null);
        const calendarDate = ref(new Date());
        const ganttFilterAssignee = ref('');
        const showAddLink = ref(false);
        const newLinkName = ref('');
        const newLinkUrl = ref('');
        const importMode = ref('merge');
        const importFileInput = ref(null);
        const importPreview = ref(null);
        const uploading = ref(false);
        const toast = ref({ show: false, message: '', type: 'info' });

        // ===== æ–°å¢åŠŸèƒ½ç‹€æ…‹ =====
        // æ·±è‰²æ¨¡å¼
        const darkMode = ref(localStorage.getItem('darkMode') === 'true');
        const themeColor = ref(localStorage.getItem('themeColor') || 'indigo');

        // å…±åŒç·¨è¼¯
        const docList = ref([]);
        const currentDocId = ref('main');
        const docContent = ref('');
        const docLocked = ref(false);
        const docSaveStatus = ref('å·²å„²å­˜');
        const docVersions = ref([]);
        let docSaveTimer = null;
        let isRemoteDocUpdate = false;
        let unsubscribeDoc = null;

        // èŠå¤©
        const chatMessages = ref([]);
        const chatInput = ref('');

        // å…¬å‘Šåˆ†äº«
        const allNotes = ref([]);
        const newNoteTitle = ref('');
        const newNoteContent = ref('');
        const newNotePinned = ref(false);
        const noteSearch = ref('');

        // å€‹äººå¾…è¾¦
        const myTodos = ref([]);
        const newTodoText = ref('');

        // æ´»å‹•ç´€éŒ„
        const activityLogs = ref([]);

        // åœ¨ç·šç”¨æˆ¶
        const onlineUsers = ref([]);

        // ===== å¸¸æ•¸ =====
        const columnColors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444', '#06b6d4'];
        const labelNames = { urgent: 'ç·Šæ€¥', important: 'é‡è¦', normal: 'ä¸€èˆ¬', feature: 'åŠŸèƒ½', bug: 'éŒ¯èª¤' };
        const views = [
          { id: 'board', icon: 'ğŸ“‹', name: 'çœ‹æ¿' },
          { id: 'calendar', icon: 'ğŸ“…', name: 'æ—¥æ›†' },
          { id: 'gantt', icon: 'ğŸ“Š', name: 'ç”˜ç‰¹åœ–' },
          { id: 'docs', icon: 'ğŸ“', name: 'ç·¨è¼¯' },
          { id: 'chat', icon: 'ğŸ’¬', name: 'èŠå¤©' },
          { id: 'share', icon: 'ğŸ“', name: 'åˆ†äº«' },
          { id: 'todo', icon: 'âœ…', name: 'å¾…è¾¦' },
          { id: 'log', icon: 'ğŸ“ˆ', name: 'ç´€éŒ„' },
        ];
        const themeColors = [
          { name: 'indigo', label: 'é›è—', primary: '#6366f1' },
          { name: 'purple', label: 'ç´«è‰²', primary: '#7c4dff' },
          { name: 'teal', label: 'é’è‰²', primary: '#00bfa5' },
          { name: 'orange', label: 'æ©˜è‰²', primary: '#ff6d00' },
          { name: 'pink', label: 'ç²‰ç´…', primary: '#e91e63' },
          { name: 'slate', label: 'ç°è—', primary: '#455a64' },
        ];

        // ===== ç›£è½å™¨ =====
        let unsubBoards = null, unsubColumns = null, unsubCards = null, unsubUsers = null;
        let unsubAllCards = null, unsubDocs = null, unsubChat = null, unsubNotes = null;
        let unsubTodos = null, unsubLogs = null, unsubOnline = null;
        
        const toDateStr = (d) => { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${dd}`; };
        
        // ===== è¨ˆç®—å±¬æ€§ =====
        const sortedColumns = computed(() => [...columns.value].sort((a, b) => a.orderIndex - b.orderIndex));
        const displayCards = computed(() => showAllBoards.value ? allBoardsCards.value : cards.value);

        const calendarTitle = computed(() => {
          const y = calendarDate.value.getFullYear(), m = calendarDate.value.getMonth() + 1;
          return `${y} å¹´ ${m} æœˆ`;
        });

        const calendarDays = computed(() => {
  const y = calendarDate.value.getFullYear(), m = calendarDate.value.getMonth();
  const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
  const days = [];
  for (let i = 0; i < first.getDay(); i++) {
    const d = new Date(y, m, -first.getDay() + i + 1);
    days.push({ date: toDateStr(d), dayNum: d.getDate(), isCurrentMonth: false, isToday: false, cards: [] });
  }
  const today = toDateStr(new Date());
  for (let i = 1; i <= last.getDate(); i++) {
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    days.push({ date: ds, dayNum: i, isCurrentMonth: true, isToday: ds === today, cards: displayCards.value.filter(c => { if (c.startDate && ds === c.startDate) return true; if (c.dueDate && ds === c.dueDate) return true; if (!c.startDate && !c.dueDate) return false; if (c.startDate && !c.dueDate && ds === c.startDate) return true; if (!c.startDate && c.dueDate && ds === c.dueDate) return true; return false; }).map(c => ({ ...c, _label: ds === c.startDate ? 'é–‹å§‹' : 'çµæŸ' })) });
  }
  const rem = 42 - days.length;
  for (let i = 1; i <= rem; i++) {
    const d = new Date(y, m + 1, i);
    days.push({ date: toDateStr(d), dayNum: d.getDate(), isCurrentMonth: false, isToday: false, cards: [] });
  }
  return days;
});

        const ganttDates = computed(() => {
  const cardsWithDates = displayCards.value.filter(c => c.startDate || c.dueDate);
  let minDate = new Date(), maxDate = new Date();
  minDate.setDate(minDate.getDate() - 7);
  maxDate.setDate(maxDate.getDate() + 30);
  cardsWithDates.forEach(c => {
    if (c.startDate && new Date(c.startDate) < minDate) minDate = new Date(c.startDate);
    if (c.dueDate && new Date(c.dueDate) > maxDate) maxDate = new Date(c.dueDate);
  });
  minDate.setDate(minDate.getDate() - 2);
  maxDate.setDate(maxDate.getDate() + 2);
  const dates = [];
  const current = new Date(minDate);
  while (current <= maxDate) { dates.push(toDateStr(current)); current.setDate(current.getDate() + 1); }
  return dates;
});

        const allAssignees = computed(() => {
          const s = new Set(); cards.value.forEach(c => { if (c.assignee) s.add(c.assignee); }); return Array.from(s);
        });

        const filteredGanttCards = computed(() => {
          let f = displayCards.value.filter(c => c.dueDate || c.startDate);
          if (ganttFilterAssignee.value) f = f.filter(c => c.assignee === ganttFilterAssignee.value);
          return f;
        });

        const filteredNotes = computed(() => {
          let notes = [...allNotes.value];
          if (noteSearch.value) {
            const kw = noteSearch.value.toLowerCase();
            notes = notes.filter(n => (n.title||'').toLowerCase().includes(kw) || (n.content||'').toLowerCase().includes(kw));
          }
          const pinned = notes.filter(n => n.pinned);
          const normal = notes.filter(n => !n.pinned);
          return [...pinned, ...normal];
        });

        // ===== å·¥å…·å‡½å¼ =====
        const showToast = (msg, type='info') => { toast.value = { show: true, message: msg, type }; setTimeout(() => toast.value.show = false, 3000); };
        const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const formatDate = (s) => { if (!s) return ''; const d = new Date(s); return `${d.getMonth()+1}/${d.getDate()}`; };
        const formatDateTime = (ts) => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString('zh-TW'); };
        const formatMsgTime = (ts) => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'}); };
        const formatLogTime = (ts) => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString('zh-TW'); };
        const formatNoteTime = (ts) => formatLogTime(ts);
        const getDueDateClass = (s) => { if (!s) return ''; const diff = (new Date(s) - new Date()) / 864e5; if (diff < 0) return 'text-red-600 font-medium'; if (diff <= 2) return 'text-orange-500'; return 'text-gray-500'; };
        const getLabelBgClass = (l) => ({ urgent:'bg-red-500', important:'bg-yellow-500', normal:'bg-green-500', feature:'bg-blue-500', bug:'bg-purple-500' }[l] || 'bg-gray-500');
        const isToday = (s) => s === toDateStr(new Date());
        const getGanttBarStyle = (card) => {
  const s = card.startDate || card.dueDate, e = card.dueDate || card.startDate;
  if (!s || !e) return { display: 'none' };
  const dates = ganttDates.value;
  const firstDate = dates[0], lastDate = dates[dates.length - 1];
  if (e < firstDate || s > lastDate) return { display: 'none' };
  const clampedStart = s < firstDate ? firstDate : s;
  const clampedEnd = e > lastDate ? lastDate : e;
  const si = dates.indexOf(clampedStart);
  const ei = dates.indexOf(clampedEnd);
  if (si === -1 || ei === -1) return { display: 'none' };
  const left = si * 32;
  const width = Math.max(1, (ei - si + 1)) * 32;
  return { left: left + 'px', width: width + 'px' };
};
  const linkifyText = (text) => { if (!text) return ''; return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$1</a>'); };

        // ===== æ·±è‰²æ¨¡å¼ =====
        const toggleDarkMode = () => {
          darkMode.value = !darkMode.value;
          localStorage.setItem('darkMode', darkMode.value);
          document.documentElement.classList.toggle('dark', darkMode.value);
        };
        const setThemeColor = (c) => {
          themeColor.value = c.name;
          localStorage.setItem('themeColor', c.name);
          showToast(`å·²åˆ‡æ›ç‚º${c.label}ä¸»é¡Œ`, 'success');
        };

        // ===== Auth =====
        const signInWithGoogle = async () => {
        try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        catch (e) { if (e.code !== 'auth/popup-closed-by-user') { error.value = 'ç™»å…¥å¤±æ•—ï¼š' + e.message; } }
           };
        const signOut = async () => {
          if (currentUser.value) {
            await db.collection('online').doc(currentUser.value.uid).delete().catch(()=>{});
          }
          await auth.signOut();
          currentUser.value = null; isAuthorized.value = false; role.value = '';
        };

        // ===== åˆå§‹åŒ– =====
        const initialize = () => {
          if (darkMode.value) document.documentElement.classList.add('dark');
                    
             auth.onAuthStateChanged(async (user) => {
            if (user) {
              loading.value = true;
              currentUser.value = user;
              try {
                const doc = await db.collection('authorized_users').doc(user.email.toLowerCase()).get();
                if (doc.exists) {
                  isAuthorized.value = true;
                  role.value = doc.data().role || 'member';
                  await db.collection('authorized_users').doc(user.email.toLowerCase()).update({ lastLogin: new Date().toISOString() });
                  startAllListeners();
                } else {
                  const snap = await db.collection('authorized_users').get();
                  if (snap.empty) {
                    await db.collection('authorized_users').doc(user.email.toLowerCase()).set({
                      email: user.email, role: 'admin', displayName: user.displayName, photoURL: user.photoURL,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastLogin: new Date().toISOString()
                    });
                    isAuthorized.value = true; role.value = 'admin';
                    showToast('æ­¡è¿ï¼å·²è¨­ç‚ºç®¡ç†å“¡', 'success');
                    startAllListeners();
                  } else { isAuthorized.value = false; }
                }
              } catch (e) { error.value = 'æª¢æŸ¥æˆæ¬Šå¤±æ•—'; }
              loading.value = false;
            } else { loading.value = false; currentUser.value = null; isAuthorized.value = false; }
          });
        };

        // ===== å•Ÿå‹•æ‰€æœ‰ç›£è½ =====
        const startAllListeners = () => {
          // çœ‹æ¿
          unsubBoards = db.collection('boards').orderBy('createdAt','asc').onSnapshot(s => {
            boards.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
            if (!currentBoardId.value && boards.value.length > 0) currentBoardId.value = boards.value[0].id;
          });
          // æˆæ¬Šç”¨æˆ¶
          unsubUsers = db.collection('authorized_users').orderBy('createdAt','asc').onSnapshot(s => {
            authorizedUsers.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
          // æ–‡ä»¶åˆ—è¡¨
          unsubDocs = db.collection('documents').onSnapshot(s => {
            docList.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
            if (docList.value.length === 0) {
              db.collection('documents').doc('main').set({ title: 'ä¸»æ–‡ä»¶', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
          // èŠå¤©
          unsubChat = db.collection('chat').orderBy('time').onSnapshot(s => {
            chatMessages.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
            nextTick(() => { const box = document.getElementById('chatBox'); if (box) box.scrollTop = box.scrollHeight; });
          });
          // å…¬å‘Šåˆ†äº«
          unsubNotes = db.collection('notes').orderBy('createdAt','desc').onSnapshot(s => {
            allNotes.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
          // å€‹äººå¾…è¾¦
          if (currentUser.value) {
            unsubTodos = db.collection('todos').where('uid','==',currentUser.value.uid).orderBy('createdAt').onSnapshot(s => {
              myTodos.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
            });
          }
          // æ´»å‹•ç´€éŒ„
          unsubLogs = db.collection('logs').orderBy('time','desc').limit(50).onSnapshot(s => {
            activityLogs.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
          // åœ¨ç·šç”¨æˆ¶
          if (currentUser.value) {
            db.collection('online').doc(currentUser.value.uid).set({
              name: currentUser.value.displayName, photo: currentUser.value.photoURL,
              time: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          unsubOnline = db.collection('online').onSnapshot(s => {
            onlineUsers.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
          // è¼‰å…¥æ–‡ä»¶
          listenDoc();
        };

        // ===== çœ‹æ¿ =====
        watch(currentBoardId, (id) => {
          if (unsubColumns) unsubColumns();
          if (unsubCards) unsubCards();
          if (!id) { columns.value = []; cards.value = []; return; }
          unsubColumns = db.collection('columns').where('boardId','==',id).onSnapshot(s => {
            columns.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
          unsubCards = db.collection('cards').where('boardId','==',id).onSnapshot(s => {
            cards.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          });
        });

        const createBoard = async () => {
          if (!newBoardName.value.trim()) return;
          const id = genId();
          await db.collection('boards').doc(id).set({ name: newBoardName.value.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: currentUser.value.email });
          currentBoardId.value = id; newBoardName.value = ''; showNewBoardModal.value = false;
          addLog('å»ºç«‹äº†çœ‹æ¿ã€Œ' + newBoardName.value + 'ã€');
          showToast('çœ‹æ¿å·²å»ºç«‹','success');
        };

        const deleteBoard = async () => {
          const b = boards.value.find(b => b.id === currentBoardId.value);
          if (!b || !confirm(`ç¢ºå®šåˆªé™¤ã€Œ${b.name}ã€ï¼Ÿæ‰€æœ‰å¡ç‰‡ä¹Ÿæœƒåˆªé™¤ï¼`)) return;
          const batch = db.batch();
          cards.value.filter(c => c.boardId === currentBoardId.value).forEach(c => batch.delete(db.collection('cards').doc(c.id)));
          columns.value.filter(c => c.boardId === currentBoardId.value).forEach(c => batch.delete(db.collection('columns').doc(c.id)));
          batch.delete(db.collection('boards').doc(currentBoardId.value));
          await batch.commit();
          currentBoardId.value = ''; addLog('åˆªé™¤äº†çœ‹æ¿'); showToast('çœ‹æ¿å·²åˆªé™¤','success');
        };

        // ===== æ¬„ä½ =====
        const createColumn = async () => {
          if (!newColumnName.value.trim() || !currentBoardId.value) return;
          const maxOrd = columns.value.length > 0 ? Math.max(...columns.value.map(c => c.orderIndex || 0)) : 0;
          await db.collection('columns').doc(genId()).set({
            boardId: currentBoardId.value, name: newColumnName.value.trim(), color: newColumnColor.value,
            orderIndex: maxOrd + 1, createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          newColumnName.value = ''; showNewColumnModal.value = false; showToast('æ¬„ä½å·²å»ºç«‹','success');
        };
        const openColumnMenu = (col) => { selectedColumn.value = col; showColumnMenu.value = true; };
        const openEditColumnModal = () => { editingColumn.value = { ...selectedColumn.value }; showColumnMenu.value = false; showEditColumnModal.value = true; };
        const saveColumn = async () => { await db.collection('columns').doc(editingColumn.value.id).update({ name: editingColumn.value.name, color: editingColumn.value.color }); showEditColumnModal.value = false; showToast('å·²æ›´æ–°','success'); };
        const confirmArchiveColumn = () => { archivingColumn.value = selectedColumn.value; showColumnMenu.value = false; showArchiveConfirm.value = true; };
        const archiveColumn = async () => {
          const batch = db.batch();
          cards.value.filter(c => c.columnId === archivingColumn.value.id).forEach(c => batch.delete(db.collection('cards').doc(c.id)));
          batch.delete(db.collection('columns').doc(archivingColumn.value.id));
          await batch.commit(); showArchiveConfirm.value = false; showToast('æ¬„ä½å·²åˆªé™¤','success');
        };

        // ===== å¡ç‰‡ =====
        const openNewCardModal = (col) => { selectedColumnForNewCard.value = col; showNewCardModal.value = true; };
        const createCard = async () => {
          if (!newCardTitle.value.trim() || !selectedColumnForNewCard.value) return;
          const colCards = cards.value.filter(c => c.columnId === selectedColumnForNewCard.value.id);
          const maxOrd = colCards.length > 0 ? Math.max(...colCards.map(c => c.orderIndex||0)) : 0;
          await db.collection('cards').doc(genId()).set({
            boardId: currentBoardId.value, columnId: selectedColumnForNewCard.value.id,
            title: newCardTitle.value.trim(), description: '', labels: [], checklist: [],
            images: [], files: [], externalLinks: [], orderIndex: maxOrd + 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: currentUser.value.email
          });
          addLog('æ–°å¢äº†å¡ç‰‡ã€Œ' + newCardTitle.value + 'ã€');
          newCardTitle.value = ''; showNewCardModal.value = false; showToast('å¡ç‰‡å·²å»ºç«‹','success');
        };
        const openCardDetail = async (card) => {
          editingCard.value = JSON.parse(JSON.stringify(card));
          editingCard.value.externalLinks = editingCard.value.externalLinks || [];
          editingCard.value.checklist = editingCard.value.checklist || [];
          editingCard.value.labels = editingCard.value.labels || [];
          showCardDetail.value = true; showAddLink.value = false;
          try {
            const s = await db.collection('comments').where('cardId','==',card.id).orderBy('createdAt','desc').get();
            cardComments.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          } catch(e) { cardComments.value = []; }
        };
        const closeCardDetail = () => { showCardDetail.value = false; editingCard.value = {}; showAddLink.value = false; };
        const saveCard = async () => {
          const data = { ...editingCard.value }; delete data.id;
          await db.collection('cards').doc(editingCard.value.id).update(data);
          showToast('å·²å„²å­˜','success'); closeCardDetail();
        };
        const deleteCard = async () => {
          if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
          await db.collection('cards').doc(editingCard.value.id).delete();
          addLog('åˆªé™¤äº†å¡ç‰‡'); showToast('å·²åˆªé™¤','success'); closeCardDetail();
        };
        const toggleLabel = (l) => {
          if (!editingCard.value.labels) editingCard.value.labels = [];
          const i = editingCard.value.labels.indexOf(l);
          if (i === -1) editingCard.value.labels.push(l); else editingCard.value.labels.splice(i, 1);
        };
        const addCardLink = () => {
          if (!newLinkUrl.value) return showToast('è«‹è¼¸å…¥ç¶²å€','error');
          editingCard.value.externalLinks.push({ name: newLinkName.value || newLinkUrl.value, url: newLinkUrl.value });
          newLinkName.value = ''; newLinkUrl.value = ''; showAddLink.value = false;
        };
        const addComment = async () => {
          if (!newComment.value.trim()) return;
          await db.collection('comments').doc(genId()).set({
            cardId: editingCard.value.id, content: newComment.value.trim(),
            author: currentUser.value.displayName || currentUser.value.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          newComment.value = '';
          const s = await db.collection('comments').where('cardId','==',editingCard.value.id).orderBy('createdAt','desc').get();
          cardComments.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        // ===== æ‹–æ‹‰ =====
        const onCardDragStart = (e, card) => { draggingCard.value = card; e.target.classList.add('card-dragging'); };
        const onCardDragEnd = (e) => { draggingCard.value = null; e.target.classList.remove('card-dragging'); };
        const onCardDrop = async (e, col) => {
          e.currentTarget.classList.remove('drag-over');
          if (!draggingCard.value || draggingCard.value.columnId === col.id) return;
          const colCards = cards.value.filter(c => c.columnId === col.id);
          const maxOrd = colCards.length > 0 ? Math.max(...colCards.map(c => c.orderIndex||0)) : 0;
          await db.collection('cards').doc(draggingCard.value.id).update({ columnId: col.id, orderIndex: maxOrd + 1 });
          showToast('å¡ç‰‡å·²ç§»å‹•','success');
        };
        const onCalendarDrop = async (e, dateStr) => {
          if (!draggingCard.value) return;
          await db.collection('cards').doc(draggingCard.value.id).update({ dueDate: dateStr });
          showToast('åˆ°æœŸæ—¥å·²æ›´æ–°','success');
        };
        const prevMonth = () => { const d = new Date(calendarDate.value); d.setMonth(d.getMonth()-1); calendarDate.value = d; };
        const nextMonth = () => { const d = new Date(calendarDate.value); d.setMonth(d.getMonth()+1); calendarDate.value = d; };

        // ===== ä½¿ç”¨è€…ç®¡ç† =====
        const addUser = async () => {
          const email = newUserEmail.value.trim().toLowerCase();
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email','error');
          const existing = await db.collection('authorized_users').doc(email).get();
          if (existing.exists) return showToast('å·²åœ¨æˆæ¬Šåå–®ä¸­','error');
          await db.collection('authorized_users').doc(email).set({
            email, role: newUserRole.value, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: currentUser.value.email
          });
          newUserEmail.value = ''; showToast('å·²æ–°å¢','success');
        };
        const updateUserRole = async (user, r) => { await db.collection('authorized_users').doc(user.email).update({ role: r }); showToast('å·²æ›´æ–°','success'); };
        const removeUser = async (user) => { if (confirm(`ç§»é™¤ã€Œ${user.email}ã€ï¼Ÿ`)) { await db.collection('authorized_users').doc(user.email).delete(); showToast('å·²ç§»é™¤','success'); } };

        // ===== åŒ¯å‡ºåŒ¯å…¥ =====
        const exportBackup = () => {
          const data = { exportDate: new Date().toISOString(), data: { boards: boards.value, columns: columns.value, cards: cards.value } };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = `backup-${toDateStr(new Date())}.json`; a.click();
          showToast('å‚™ä»½å·²ä¸‹è¼‰','success');
        };
        const openImportModal = () => { showImportModal.value = true; importPreview.value = null; importMode.value = 'merge'; };
        const closeImportModal = () => { showImportModal.value = false; importPreview.value = null; };
        const handleImportFile = (e) => {
          const file = e.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              if (!data.data?.boards) return showToast('æ ¼å¼ä¸æ­£ç¢º','error');
              importPreview.value = { boardCount: data.data.boards?.length||0, columnCount: data.data.columns?.length||0, cardCount: data.data.cards?.length||0, rawData: data.data };
            } catch(e) { showToast('ç„¡æ³•è§£ææª”æ¡ˆ','error'); }
          };
          reader.readAsText(file);
        };
        const executeImport = async () => {
          if (!importPreview.value || !confirm(importMode.value === 'merge' ? 'ç¢ºå®šåˆä½µåŒ¯å…¥ï¼Ÿ' : 'ç¢ºå®šè¦†è“‹åŒ¯å…¥ï¼Ÿæ‰€æœ‰è³‡æ–™æœƒè¢«æ¸…é™¤ï¼')) return;
          const batch = db.batch(), data = importPreview.value.rawData;
          const bMap = {}, cMap = {};
          if (importMode.value === 'replace') {
            cards.value.forEach(c => batch.delete(db.collection('cards').doc(c.id)));
            columns.value.forEach(c => batch.delete(db.collection('columns').doc(c.id)));
            boards.value.forEach(b => batch.delete(db.collection('boards').doc(b.id)));
          }
          if (data.boards) data.boards.forEach(b => {
            const nid = importMode.value === 'merge' ? genId() : b.id; bMap[b.id] = nid;
            batch.set(db.collection('boards').doc(nid), { ...b, id: nid, name: importMode.value === 'merge' ? b.name + ' (åŒ¯å…¥)' : b.name });
          });
          if (data.columns) data.columns.forEach(c => {
            const nid = importMode.value === 'merge' ? genId() : c.id; cMap[c.id] = nid;
            batch.set(db.collection('columns').doc(nid), { ...c, id: nid, boardId: bMap[c.boardId]||c.boardId });
          });
          if (data.cards) data.cards.forEach(c => {
            const nid = importMode.value === 'merge' ? genId() : c.id;
            batch.set(db.collection('cards').doc(nid), { ...c, id: nid, boardId: bMap[c.boardId]||c.boardId, columnId: cMap[c.columnId]||c.columnId });
          });
          await batch.commit();
          showToast('åŒ¯å…¥å®Œæˆï¼','success'); closeImportModal();
        };

        // ===== å…±åŒç·¨è¼¯ =====
        const listenDoc = () => {
          if (unsubscribeDoc) unsubscribeDoc();
          unsubscribeDoc = db.collection('docs-content').doc(currentDocId.value).onSnapshot(s => {
            if (s.exists) {
              const data = s.data();
              if (data.lastEditBy !== currentUser.value?.uid) {
                isRemoteDocUpdate = true;
                docContent.value = data.content || '';
                isRemoteDocUpdate = false;
              }
              docLocked.value = !!data.locked;
              docSaveStatus.value = `æœ€å¾Œç”± ${data.lastEditName || 'æœªçŸ¥'} ç·¨è¼¯`;
            }
          });
        };

        const switchDoc = (id) => { currentDocId.value = id; listenDoc(); };

        const onDocInput = () => {
          if (isRemoteDocUpdate) return;
          docSaveStatus.value = 'å„²å­˜ä¸­...';
          clearTimeout(docSaveTimer);
          docSaveTimer = setTimeout(async () => {
            await db.collection('docs-content').doc(currentDocId.value).set({
              content: docContent.value, lastEditBy: currentUser.value.uid,
              lastEditName: currentUser.value.displayName, time: firebase.firestore.FieldValue.serverTimestamp(), locked: false
            });
            await db.collection('doc-versions').add({
              docId: currentDocId.value, content: docContent.value, editBy: currentUser.value.displayName,
              time: firebase.firestore.FieldValue.serverTimestamp()
            });
            docSaveStatus.value = 'å·²å„²å­˜ âœ“';
          }, 1500);
        };

        const createDoc = async () => {
          const title = prompt('è«‹è¼¸å…¥æ–‡ä»¶åç¨±ï¼š'); if (!title) return;
          const ref = await db.collection('documents').add({ title, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          currentDocId.value = ref.id; listenDoc();
          addLog('å»ºç«‹äº†æ–‡ä»¶ã€Œ' + title + 'ã€');
        };

        const createMeetingDoc = async () => {
          const dateStr = new Date().toLocaleDateString('zh-TW');
          const title = `æœƒè­°è¨˜éŒ„ ${dateStr}`;
          const template = `ğŸ“ æœƒè­°è¨˜éŒ„\næ—¥æœŸï¼š${dateStr}\nå‡ºå¸­è€…ï¼š\n\nğŸ“Œ è¨è«–äº‹é …ï¼š\n1. \n2. \n3. \n\nâœ… æ±ºè­°äº‹é …ï¼š\n1. \n2. \n\nğŸ“‹ å¾…è¾¦è¿½è¹¤ï¼š\n- \n- \n\nğŸ“ å‚™è¨»ï¼š\n`;
          const ref = await db.collection('documents').add({ title, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          await db.collection('docs-content').doc(ref.id).set({
            content: template, lastEditBy: currentUser.value.uid, lastEditName: currentUser.value.displayName,
            time: firebase.firestore.FieldValue.serverTimestamp(), locked: false
          });
          currentDocId.value = ref.id; listenDoc();
          addLog('å»ºç«‹äº†æœƒè­°è¨˜éŒ„');
        };

        const removeDoc = async (id) => {
          if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–‡ä»¶ï¼Ÿ')) return;
          await db.collection('documents').doc(id).delete();
          await db.collection('docs-content').doc(id).delete().catch(()=>{});
          if (currentDocId.value === id) { currentDocId.value = 'main'; listenDoc(); }
          addLog('åˆªé™¤äº†ä¸€ä»½æ–‡ä»¶');
        };

        const exportDoc = () => {
          const d = docList.value.find(d => d.id === currentDocId.value);
          const blob = new Blob([docContent.value], { type: 'text/plain;charset=utf-8' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = (d?.title || 'æ–‡ä»¶') + '.txt'; a.click();
        };

        const toggleDocLock = async () => {
          const snap = await db.collection('docs-content').doc(currentDocId.value).get();
          const locked = snap.exists ? !snap.data().locked : true;
          await db.collection('docs-content').doc(currentDocId.value).update({ locked });
          addLog(locked ? 'é–å®šäº†æ–‡ä»¶' : 'è§£é–äº†æ–‡ä»¶');
        };

        const showDocVersions = async () => {
          const s = await db.collection('doc-versions').where('docId','==',currentDocId.value).orderBy('time','desc').limit(20).get();
          docVersions.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
          showVersionModal.value = true;
        };

        const restoreVersion = async (v) => {
          if (!confirm('ç¢ºå®šé‚„åŸæ­¤ç‰ˆæœ¬ï¼Ÿ')) return;
          await db.collection('docs-content').doc(currentDocId.value).set({
            content: v.content, lastEditBy: currentUser.value.uid, lastEditName: currentUser.value.displayName,
            time: firebase.firestore.FieldValue.serverTimestamp(), locked: false
          });
          docContent.value = v.content; showVersionModal.value = false;
          addLog('é‚„åŸäº†æ–‡ä»¶ç‰ˆæœ¬'); showToast('å·²é‚„åŸ','success');
        };

        // ===== èŠå¤© =====
        const sendChat = async () => {
          if (!chatInput.value.trim()) return;
          await db.collection('chat').add({
            name: currentUser.value.displayName, photo: currentUser.value.photoURL,
            uid: currentUser.value.uid, text: chatInput.value.trim(),
            readBy: [currentUser.value.uid], time: firebase.firestore.FieldValue.serverTimestamp()
          });
          chatInput.value = '';
        };

        // ===== å…¬å‘Šåˆ†äº« =====
        const addNote = async () => {
          if (!newNoteTitle.value.trim() || !newNoteContent.value.trim()) return showToast('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹','error');
          await db.collection('notes').add({
            title: newNoteTitle.value.trim(), content: newNoteContent.value.trim(), pinned: newNotePinned.value,
            author: currentUser.value.displayName, createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          addLog('åˆ†äº«äº†ã€Œ' + newNoteTitle.value + 'ã€');
          newNoteTitle.value = ''; newNoteContent.value = ''; newNotePinned.value = false;
        };
        const toggleNotePin = async (note) => { await db.collection('notes').doc(note.id).update({ pinned: !note.pinned }); };
        const deleteNote = async (id) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await db.collection('notes').doc(id).delete(); addLog('åˆªé™¤äº†ä¸€å‰‡åˆ†äº«'); } };

        // ===== å€‹äººå¾…è¾¦ =====
        const addTodo = async () => {
          if (!newTodoText.value.trim()) return;
          await db.collection('todos').add({ text: newTodoText.value.trim(), done: false, uid: currentUser.value.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          newTodoText.value = '';
        };
        const toggleTodo = async (todo) => { await db.collection('todos').doc(todo.id).update({ done: !todo.done }); };
        const deleteTodo = async (id) => { await db.collection('todos').doc(id).delete(); };

        // ===== æ´»å‹•ç´€éŒ„ =====
        const addLog = async (action) => {
          await db.collection('logs').add({ user: currentUser.value.displayName, action, time: firebase.firestore.FieldValue.serverTimestamp() });
        };

        // ===== ç”Ÿå‘½é€±æœŸ =====
        onMounted(() => { initialize(); });
        onUnmounted(() => {
          [unsubBoards, unsubColumns, unsubCards, unsubUsers, unsubDocs, unsubChat, unsubNotes, unsubTodos, unsubLogs, unsubOnline, unsubscribeDoc, unsubAllCards].forEach(u => { if (u) u(); });
        });

        return {
          loading, error, showRetryLogin, currentUser, isAuthorized, role, authorizedUsers,
          showUserManagement, newUserEmail, newUserRole, signInWithGoogle, signOut,
          addUser, updateUserRole, removeUser,
          boards, columns, cards, cardComments, currentBoardId, currentView,
          showAllBoards, allBoardsCards,
          showNewBoardModal, showNewColumnModal, showNewCardModal, showCardDetail,
          showColumnMenu, showEditColumnModal, showArchiveConfirm, showImportModal,
          showToolMenu, showThemeSettings, showVersionModal,
          editingCard, editingColumn, selectedColumn, archivingColumn,
          newBoardName, newColumnName, newColumnColor, newCardTitle, newComment,
          draggingCard, calendarDate, ganttFilterAssignee,
          showAddLink, newLinkName, newLinkUrl,
          importMode, importFileInput, importPreview, uploading, toast,
          darkMode, themeColor, views, themeColors,
          docList, currentDocId, docContent, docLocked, docSaveStatus, docVersions,
          chatMessages, chatInput,
          allNotes, newNoteTitle, newNoteContent, newNotePinned, noteSearch,
          myTodos, newTodoText, activityLogs, onlineUsers,
          columnColors, labelNames,
          sortedColumns, displayCards, calendarTitle, calendarDays, ganttDates,
          allAssignees, filteredGanttCards, filteredNotes,
          formatDate, formatDateTime, formatMsgTime, formatLogTime, formatNoteTime,
          getDueDateClass, getLabelBgClass, isToday, getGanttBarStyle, linkifyText,
          toggleDarkMode, setThemeColor,
          createBoard, deleteBoard, createColumn, openColumnMenu, openEditColumnModal,
          saveColumn, confirmArchiveColumn, archiveColumn,
          openNewCardModal, createCard, openCardDetail, closeCardDetail, saveCard, deleteCard,
          toggleLabel, addCardLink, addComment,
          onCardDragStart, onCardDragEnd, onCardDrop, onCalendarDrop, prevMonth, nextMonth,
          exportBackup, openImportModal, closeImportModal, handleImportFile, executeImport,
          switchDoc, onDocInput, createDoc, createMeetingDoc, removeDoc, exportDoc,
          toggleDocLock, showDocVersions, restoreVersion,
          sendChat, addNote, toggleNotePin, deleteNote,
          addTodo, toggleTodo, deleteTodo,
          showToast
        };
      }
    }).mount('#app');
  </script>
</body>
</html>










